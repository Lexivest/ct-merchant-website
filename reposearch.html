<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Merchant Discovery | CT-MERCHANT LTD.</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --color-purple: #2E1065;
            --color-pink: #DB2777;
            --color-bg: #0F172A;
            --color-text: #1E293B;
            --color-muted: #64748B;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }

        body {
            background-color: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* --- CARD --- */
        .repo-card {
            background: white;
            width: 100%;
            max-width: 400px;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .card-close-btn {
            position: absolute; top: 16px; right: 16px;
            width: 32px; height: 32px; background: rgba(0,0,0,0.1);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #333; cursor: pointer; z-index: 10; text-decoration: none;
            transition: background 0.2s;
        }
        .card-close-btn:hover { background: rgba(0,0,0,0.2); }

        /* Brand Header */
        .card-brand {
            padding: 16px; border-bottom: 1px solid #F1F5F9;
            display: flex; align-items: center; gap: 10px;
            background: white;
        }
        .card-brand-logo { width: 32px; height: 32px; border-radius: 8px; }
        .card-brand-text { font-weight: 800; font-size: 0.9rem; color: var(--color-purple); }

        /* Content Area */
        .header-bg { height: 100px; background: linear-gradient(135deg, var(--color-purple), var(--color-pink)); }
        
        .profile-section { padding: 0 24px 24px 24px; margin-top: -50px; position: relative; text-align: center; }
        
        .logo-wrapper {
            width: 100px; height: 100px; margin: 0 auto;
            border-radius: 20px; border: 4px solid white;
            background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden; position: relative;
        }
        .repo-logo { width: 100%; height: 100%; object-fit: cover; }
        
        /* Status Dot */
        .status-dot {
            width: 16px; height: 16px; border-radius: 50%; border: 3px solid white;
            position: absolute; bottom: 5px; right: calc(50% - 45px);
        }
        .status-open { background-color: #22C55E; }
        .status-closed { background-color: #EF4444; }

        .biz-info { margin-top: 12px; }
        .biz-name { font-size: 1.5rem; font-weight: 800; color: var(--color-text); margin-bottom: 4px; line-height: 1.2; }
        .owner-label { color: var(--color-muted); font-size: 0.9rem; font-weight: 500; }

        .badges { margin: 16px 0; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .badge-id { background: #F3E8FF; color: var(--color-purple); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.5px; border: 1px solid #E9D5FF; }
        .badge-loc { display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: var(--color-muted); font-weight: 600; background: #F1F5F9; padding: 4px 10px; border-radius: 6px; }

        /* Details */
        .details-grid {
            display: flex; background: #F8FAFC; border-radius: 12px;
            padding: 12px; margin-bottom: 24px; text-align: left;
            border: 1px solid #E2E8F0;
        }
        .detail-item { flex: 1; padding: 0 12px; }
        .border-left { border-left: 1px solid #E2E8F0; }
        .detail-label { display: block; font-size: 0.7rem; text-transform: uppercase; color: var(--color-muted); font-weight: 700; margin-bottom: 4px; }
        .detail-value { font-size: 0.9rem; font-weight: 600; color: var(--color-text); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Actions */
        .social-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .btn-social {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 12px; border-radius: 12px; font-weight: 700; font-size: 0.9rem;
            text-decoration: none; transition: transform 0.2s;
            border: none; cursor: pointer;
        }
        .btn-social:hover { transform: translateY(-2px); }
        .btn-whatsapp { background: #22C55E; color: white; }
        .btn-view { background: var(--color-purple); color: white; }

        /* App Promo */
        .app-promo {
            background: #1E293B; color: white; padding: 12px;
            border-radius: 12px; display: flex; align-items: center; gap: 12px;
        }
        .promo-icon {
            width: 36px; height: 36px; background: rgba(255,255,255,0.1);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
        }

        /* States */
        .state-container { text-align: center; padding: 40px; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .btn-back { display: inline-block; margin-top: 16px; padding: 10px 20px; background: white; color: black; text-decoration: none; border-radius: 8px; font-weight: 700; }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading-state" class="state-container">
        <div class="spinner"></div>
        <h3>Accessing Repository...</h3>
    </div>

    <!-- Error -->
    <div id="error-state" class="state-container hidden">
        <i class="fa-solid fa-triangle-exclamation" style="font-size: 3rem; margin-bottom: 16px; color: #FCA5A5;"></i>
        <h3>Merchant Not Found</h3>
        <p id="error-msg" style="opacity: 0.8; margin-bottom: 20px;">The ID provided does not match any verified merchant.</p>
        <a href="index.html" class="btn-back">Go Back</a>
    </div>

    <!-- Content -->
    <div id="merchant-content" class="repo-card hidden">
        <div class="card-brand">
            <img src="https://goodtvrhszsnhcyigfoi.supabase.co/storage/v1/object/public/ctm_web_files/CT-Merchant.jpg" class="card-brand-logo">
            <span class="card-brand-text">Repository Result</span>
        </div>
        <a href="index.html" class="card-close-btn"><i class="fa-solid fa-xmark"></i></a>

        <div class="header-bg"></div>

        <div class="profile-section">
            <div class="logo-wrapper">
                <img id="shop-logo" src="" class="repo-logo">
            </div>
            <!-- Status Dot -->
            <div id="shop-status-dot" class="status-dot status-closed"></div>

            <div class="biz-info">
                <h2 id="biz-name" class="biz-name"></h2>
                <p id="owner-name" class="owner-label"></p>
            </div>
            
            <div class="badges">
                <span id="ct-id-badge" class="badge-id"></span>
                <span class="badge-loc">
                    <i class="fa-solid fa-location-dot" style="color:#DB2777;"></i>
                    <span id="city-text"></span>
                </span>
            </div>

            <div class="details-grid">
                <div class="detail-item">
                    <span class="detail-label">Address</span>
                    <span id="biz-loc" class="detail-value"></span>
                </div>
                <div class="detail-item border-left">
                    <span class="detail-label">Status</span>
                    <span class="detail-value" style="color: #16A34A;">Verified</span>
                </div>
            </div>

            <div class="social-actions">
                <a id="whatsapp-btn" href="#" target="_blank" class="btn-social btn-whatsapp">
                    <i class="fa-brands fa-whatsapp"></i> Chat
                </a>
                <a id="view-shop-btn" href="#" class="btn-social btn-view">
                    <i class="fa-solid fa-store"></i> View Shop
                </a>
            </div>

            <div class="app-promo">
                <div class="promo-icon"><i class="fa-solid fa-mobile-screen"></i></div>
                <div style="text-align: left;">
                    <p style="font-weight: 700; font-size: 0.8rem;">Full Experience</p>
                    <p style="font-size: 0.7rem; opacity: 0.8;">Get the CT-Merchant App for live inventory.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://xdchacdjcgazyckacbpc.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMTIzMjEsImV4cCI6MjA4MDY4ODMyMX0.FM80U_YHA-DnPqMnD4oEiNGI07BSxGcHGqeH4JP1HlI'; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            const mid = params.get('merchantId')?.trim();
            
            if (mid) await fetchMerchant(mid);
            else renderError("No Merchant ID provided.");
        };

        async function fetchMerchant(uniqueId) {
            try {
                // Calling the Edge Function
                const { data, error } = await _supabase.functions.invoke('repo-search', {
                    body: { merchantId: uniqueId }
                });

                if (error) {
                    // Check for 404 vs 401/500
                    const msg = error.message || "Search failed";
                    throw new Error(msg);
                }

                if (data.error) {
                    throw new Error(data.error);
                }

                renderUI(data);

            } catch (e) {
                console.error("Search Error:", e);
                renderError(e.message === "Merchant not found" ? "Merchant ID not found." : "Connection failed. Please try again.");
            }
        }

        function renderUI(shop) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('merchant-content').classList.remove('hidden');

            document.getElementById('biz-name').innerText = shop.name;
            
            // Handle Profile relation safely
            const owner = shop.profiles ? shop.profiles.full_name : 'Verified Merchant';
            document.getElementById('owner-name').innerText = `Proprietor: ${owner}`;
            
            document.getElementById('ct-id-badge').innerText = shop.unique_id || 'ID Pending';
            
            // Handle City relation safely
            const city = shop.cities ? shop.cities.name : 'Local';
            document.getElementById('city-text').innerText = city;
            
            document.getElementById('biz-loc').innerText = shop.address;
            
            const logo = shop.image_url || 'https://via.placeholder.com/150';
            document.getElementById('shop-logo').src = logo;

            // Status Dot
            const dot = document.getElementById('shop-status-dot');
            if (shop.is_verified) {
                dot.className = 'status-dot status-open';
            } else {
                dot.className = 'status-dot status-closed';
            }

            // WhatsApp
            if(shop.whatsapp) {
                let num = shop.whatsapp.replace(/\D/g, '');
                if(num.startsWith('0')) num = '234' + num.substring(1);
                document.getElementById('whatsapp-btn').href = `https://wa.me/${num}`;
            } else {
                document.getElementById('whatsapp-btn').style.display = 'none';
                document.querySelector('.social-actions').style.gridTemplateColumns = '1fr';
            }

            // Link to Detail Page
            document.getElementById('view-shop-btn').href = `shop-detail.html?id=${shop.id}`;
        }

        function renderError(msg) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            if(msg) document.getElementById('error-msg').innerText = msg;
        }
    </script>
</body>
</html>
