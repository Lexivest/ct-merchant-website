<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CT-Merchant Ltd. | Staff Portal</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="styles.css">
  
  <link rel="stylesheet" href="staff-portal.css">
</head>

<body class="staff-login-body">

  <div class="login-card">
    
    <div class="login-header">
      <!-- You can update this logo URL later if you migrate your storage bucket too -->
      <img src="https://goodtvrhszsnhcyigfoi.supabase.co/storage/v1/object/public/ctm_web_files/CT-Merchant.jpg"
           alt="CT-Merchant Logo"
           class="login-logo">
      <h2 class="login-title">Staff Portal</h2>
    </div>

    <form id="login-form" class="login-form">
      <input type="email" placeholder="Email" required class="login-input" />
      <input type="password" placeholder="Password" required class="login-input" />
      <button type="submit" class="btn-login">Login</button>
    </form>

    <p id="error-message" class="error-message"></p>

    <div class="login-footer">
      <p class="footer-text">Powered by CT-MERCHANT LTD.</p>
      <a href="index.html" class="btn-home">
        Home
      </a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Updated to your CURRENT Supabase Project Credentials
    const SUPABASE_URL = "https://xdchacdjcgazyckacbpc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDA2MzMsImV4cCI6MjA4NTExNjYzM30.41V3RaUX-ii-EHysbcVpUCgm0-RsNmuOb8FmYsz72Ow";
    
    // Check if Supabase library loaded correctly
    let client;
    if (window.supabase) {
        client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("Supabase library not loaded");
    }

    const loginForm = document.getElementById("login-form");
    const errorMessage = document.getElementById("error-message");

    if (loginForm) {
        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          
          if (!client) {
              errorMessage.textContent = "System Error: Database connection failed.";
              errorMessage.classList.add("visible");
              return;
          }

          // Reset Error
          errorMessage.classList.remove("visible");
          errorMessage.textContent = "";

          const email = loginForm.querySelector("input[type='email']").value;
          const password = loginForm.querySelector("input[type='password']").value;
          const btn = loginForm.querySelector("button");
          
          // Simple loading state
          const originalText = btn.textContent;
          btn.textContent = "Verifying...";
          btn.disabled = true;

          try {
              // 1. Authenticate the user
              const { data, error } = await client.auth.signInWithPassword({ email, password });

              if (error) {
                throw new Error(error.message);
              }

              if (!data.user) {
                throw new Error("No user returned from system.");
              }

              // 2. Staff membership check against the new staff_profiles table
              const { data: staff, error: staffError } = await client
                .from("staff_profiles")
                .select("*")
                .eq("id", data.user.id)
                .single();

              if (staffError || !staff) {
                // If not staff, sign them out immediately
                await client.auth.signOut();
                throw new Error("Access denied: Restricted to staff accounts only.");
              }

              // 3. Success redirect
              window.location.href = "staff-dashboard.html";

          } catch (err) {
              errorMessage.textContent = "Login failed: " + err.message;
              errorMessage.classList.add("visible");
              btn.textContent = originalText;
              btn.disabled = false;
          }
        });
    }
  </script>

</body>
</html>
