<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products | CT‑Merchant</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --color-purple: #2E1065;
            --color-bg: #F8FAFC;
            --color-text: #1E293B;
            --color-border: #E2E8F0;
            --color-red: #EF4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--color-bg); color: var(--color-text); min-height: 100vh; display: flex; justify-content: center; padding: 20px; }

        .container { width: 100%; max-width: 600px; }

        /* Header */
        .app-bar { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .back-btn { background: white; border: 1px solid var(--color-border); width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--color-text); font-size: 1.1rem; }
        .page-title { font-size: 1.25rem; font-weight: 800; }
        .add-btn { margin-left: auto; background: var(--color-purple); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }

        /* Product List */
        .product-list { display: flex; flex-direction: column; gap: 16px; }

        .product-card {
            background: white; padding: 12px; border-radius: 16px;
            border: 1px solid var(--color-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; gap: 16px; align-items: center;
        }

        .prod-img { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; background: #F1F5F9; }
        
        .prod-info { flex: 1; }
        .prod-name { font-weight: 700; font-size: 1rem; margin-bottom: 4px; color: var(--color-text); }
        .prod-price { font-weight: 800; color: var(--color-purple); font-size: 0.95rem; }
        .prod-old-price { text-decoration: line-through; color: #94A3B8; font-size: 0.8rem; margin-left: 6px; }

        .actions { display: flex; flex-direction: column; gap: 8px; }
        .action-btn {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-edit { background: #EFF6FF; color: #1D4ED8; }
        .btn-delete { background: #FEF2F2; color: #DC2626; }

        .empty-state { text-align: center; padding: 60px 0; color: #94A3B8; }
        .spinner { width: 30px; height: 30px; border: 3px solid #E2E8F0; border-top-color: var(--color-purple); border-radius: 50%; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="app-bar">
        <button onclick="history.back()" class="back-btn"><i class="fa-solid fa-arrow-left"></i></button>
        <div class="page-title">Manage Products</div>
        <button class="add-btn" onclick="goToAdd()"><i class="fa-solid fa-plus"></i> Add</button>
    </div>

    <div id="loader" class="spinner"></div>

    <div id="product-list" class="product-list" style="display: none;">
        <!-- JS Populated -->
    </div>
    
    <div id="empty-state" class="empty-state" style="display: none;">
        <i class="fa-solid fa-box-open" style="font-size: 40px; margin-bottom: 12px;"></i>
        <p>No products found.</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = "https://xdchacdjcgazyckacbpc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDA2MzMsImV4cCI6MjA4NTExNjYzM30.41V3RaUX-ii-EHysbcVpUCgm0-RsNmuOb8FmYsz72Ow";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(window.location.search);
    const shopId = params.get('shop_id');

    window.onload = async () => {
        const { data: { session } } = await client.auth.getSession();
        if (!session) { window.location.href = "login.html"; return; }
        if (!shopId) { alert("Shop ID missing"); window.history.back(); return; }

        fetchProducts();
    };

    async function fetchProducts() {
        const { data, error } = await client
            .from('products')
            .select('*')
            .eq('shop_id', shopId)
            .eq('is_available', true)
            .order('created_at', { ascending: false });

        document.getElementById('loader').style.display = 'none';

        if (error) return alert("Error loading products");
        
        if (data.length === 0) {
            document.getElementById('empty-state').style.display = 'block';
        } else {
            renderList(data);
            document.getElementById('product-list').style.display = 'flex';
        }
    }

    function renderList(products) {
        const container = document.getElementById('product-list');
        container.innerHTML = products.map(p => {
            const hasDiscount = p.discount_price && p.discount_price < p.price;
            
            return `
                <div class="product-card">
                    <img src="${p.image_url}" class="prod-img">
                    <div class="prod-info">
                        <div class="prod-name">${p.name}</div>
                        <div>
                            <span class="prod-price">₦${(p.discount_price || p.price).toLocaleString()}</span>
                            ${hasDiscount ? `<span class="prod-old-price">₦${p.price.toLocaleString()}</span>` : ''}
                        </div>
                        <div style="font-size:0.75rem; color:#64748B; margin-top:4px;">
                            ${p.condition}
                        </div>
                    </div>
                    <div class="actions">
                        <button class="action-btn btn-edit" onclick="editProduct(${p.id})">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteProduct(${p.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function goToAdd() {
        window.location.href = `merchant-add-product.html?shop_id=${shopId}`;
    }

    function editProduct(id) {
        window.location.href = `merchant-edit-product.html?id=${id}`;
    }

    async function deleteProduct(id) {
        if(!confirm("Are you sure you want to delete this product?")) return;

        // 1. Soft Delete (Set is_available = false)
        const { error } = await client
            .from('products')
            .update({ is_available: false })
            .eq('id', id);

        if (error) alert("Failed to delete");
        else fetchProducts(); // Refresh
    }
</script>
</body>
</html>
