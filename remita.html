<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification Payment | CT-Merchant</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://remitademo.net/payment/v1/remita-pay-inline.bundle.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --color-purple: #2E1065;
            --color-amber: #D97706;
            --color-bg: #F8FAFC;
            --color-text: #1E293B;
            --color-text-muted: #64748B;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }

        body { 
            background-color: var(--color-bg); 
            color: var(--color-text); 
            min-height: 100vh;
            display: flex; 
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .checkout-card {
            background: white;
            padding: 40px 30px;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 420px;
            text-align: center;
            border: 1px solid #E2E8F0;
            position: relative;
            overflow: hidden;
        }

        .checkout-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: var(--color-amber);
        }

        .icon-circle {
            width: 64px; height: 64px;
            background: #FEF3C7;
            color: var(--color-amber);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem;
            margin: 0 auto 20px auto;
        }

        .title { font-size: 1.3rem; font-weight: 800; color: var(--color-purple); margin-bottom: 8px; }
        .subtitle { color: var(--color-text-muted); font-size: 0.95rem; line-height: 1.5; margin-bottom: 24px; }
        
        .price-box {
            background: #F1F5F9;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
        }
        .price { font-size: 2.5rem; font-weight: 800; color: #0F172A; }
        .price-label { font-size: 0.85rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;}

        .details-list {
            text-align: left;
            margin-bottom: 24px;
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 16px;
        }
        .detail-item {
            display: flex; justify-content: space-between;
            font-size: 0.9rem; margin-bottom: 12px;
        }
        .detail-item:last-child { margin-bottom: 0; }
        .detail-label { color: var(--color-text-muted); font-weight: 600; }
        .detail-value { font-weight: 700; color: #0F172A; text-align: right; }

        /* WARNING NOTE */
        .warning-note {
            background: #FEF2F2;
            color: #991B1B;
            padding: 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            text-align: left;
            line-height: 1.6;
            margin-bottom: 24px;
            border: 1px solid #FECACA;
        }
        .address-box {
            background: white;
            border: 1px dashed #FCA5A5;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            color: #7F1D1D;
            font-weight: 600;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        /* Gateway Buttons */
        .gateway-section {
            border-top: 1px dashed #E2E8F0;
            padding-top: 20px;
            margin-bottom: 15px;
        }
        .gateway-label {
            font-size: 0.85rem; font-weight: 700; color: var(--color-text-muted); 
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;
        }

        .btn-gateway {
            width: 100%; padding: 16px; border: 2px solid #E2E8F0; border-radius: 12px; background: white;
            font-size: 1.05rem; font-weight: 700; color: #0F172A; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;
        }
        .btn-gateway:hover { border-color: var(--color-purple); background: #F8FAFC; transform: translateY(-2px); }
        
        .paystack-color { color: #0BA4DB; font-size: 1.2rem; }
        .remita-color { color: #E15B26; font-size: 1.2rem; }
        
        .btn-cancel {
            background: none; border: none; color: var(--color-text-muted);
            font-weight: 600; font-size: 0.95rem; margin-top: 16px; cursor: pointer;
        }
        .btn-cancel:hover { color: #0F172A; text-decoration: underline; }

        #status-msg { margin-top: 16px; font-size: 0.95rem; font-weight: 700; color: #059669; }

        /* Processing Overlay */
        .overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; backdrop-filter: blur(4px); }
        .hidden { display: none !important; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loader-standalone { border-top-color: var(--color-purple); margin: 40px auto; }
    </style>
</head>
<body>

    <div id="loader" class="spinner loader-standalone"></div>

    <div id="checkout-content" class="checkout-card hidden">
        <div class="icon-circle">
            <i class="fa-solid fa-building-circle-check"></i>
        </div>
        
        <h2 class="title">Physical Verification</h2>
        <p class="subtitle">A one-time fee to dispatch an agent to verify your physical shop location.</p>

        <div class="price-box">
            <div class="price-label">Total Amount</div>
            <div class="price">‚Ç¶5,000</div>
        </div>

        <div class="details-list">
            <div class="detail-item">
                <span class="detail-label">Merchant</span>
                <span id="lbl-merchant" class="detail-value">Loading...</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Shop Name</span>
                <span id="lbl-shop" class="detail-value">Loading...</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">City</span>
                <span id="lbl-city" class="detail-value">Loading...</span>
            </div>
        </div>

        <!-- NEW: Industry Standard Non-Refundable Warning with Address -->
        <div class="warning-note">
            <strong><i class="fa-solid fa-triangle-exclamation"></i> Important:</strong> 
            Our field agent will visit the exact address provided below. 
            
            <div class="address-box">
                <i class="fa-solid fa-location-dot" style="margin-top: 3px;"></i>
                <span id="lbl-address">Loading registered address...</span>
            </div>

            Ensure your shop is actively operating at this location. 
            <strong>This verification fee is strictly non-refundable.</strong>
        </div>

        <div class="gateway-section" id="gateway-buttons">
            <div class="gateway-label">Select Payment Gateway</div>
            
            <button class="btn-gateway" onclick="payWithPaystack()">
                <i class="fa-solid fa-credit-card paystack-color"></i> Pay with Paystack
            </button>
            
            <button class="btn-gateway" onclick="payWithRemita()">
                <i class="fa-solid fa-building-columns remita-color"></i> Pay with Remita
            </button>
        </div>

        <div id="status-msg"></div>

        <button class="btn-cancel" onclick="window.location.href='merchant-dashboard.html'">Cancel and Return</button>
    </div>

    <!-- Processing Overlay -->
    <div id="processing-overlay" class="overlay hidden">
        <div class="spinner"></div>
        <h2 style="margin-bottom: 10px;">Verifying Securely...</h2>
        <p>Please do not close this window.</p>
    </div>

    <script>
        const SUPABASE_URL = "https://xdchacdjcgazyckacbpc.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDA2MzMsImV4cCI6MjA4NTExNjYzM30.41V3RaUX-ii-EHysbcVpUCgm0-RsNmuOb8FmYsz72Ow";
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let dynamicShopDetails = null;
        let currentUserSession = null;
        const FEE_AMOUNT = 5000;

        window.onload = async () => {
            const { data: { session } } = await client.auth.getSession();
            if (!session) { window.location.href = "login.html"; return; }
            currentUserSession = session;

            const urlParams = new URLSearchParams(window.location.search);
            const shopId = urlParams.get('shop_id');

            if (!shopId) {
                alert("Shop ID is missing.");
                window.location.href = "merchant-dashboard.html";
                return;
            }

            await fetchDetails(shopId, session.user.id);
        };

        async function fetchDetails(shopId, userId) {
            try {
                // Check if they are already verified
                const { data: shop, error: shopErr } = await client.from('shops').select('*').eq('id', shopId).single();
                if (shopErr || !shop) throw new Error("Shop not found");

                if (shop.is_verified) {
                    alert("Your shop is already physically verified!");
                    window.location.href = "merchant-dashboard.html";
                    return;
                }

                // Check if they have already PAID the fee (but agent hasn't arrived yet)
                const { data: paymentRecord } = await client
                    .from('physical_verification_payments')
                    .select('id')
                    .eq('merchant_id', userId)
                    .eq('status', 'success')
                    .maybeSingle();

                if (paymentRecord) {
                    alert("You have already paid the verification fee! Our agent will contact you soon.");
                    window.location.href = "merchant-dashboard.html";
                    return;
                }

                const { data: profile, error: profErr } = await client.from('profiles').select('*, cities(name)').eq('id', userId).single();
                if (profErr || !profile) throw new Error("Profile not found");

                dynamicShopDetails = {
                    merchantName: profile.full_name || "Merchant",
                    shopName: shop.name,
                    cityName: profile.cities?.name || "Unknown City",
                    shopAddress: shop.address || "Address not provided", // Extracted Address
                    email: currentUserSession.user.email
                };

                // Populate UI Elements
                document.getElementById('lbl-merchant').textContent = dynamicShopDetails.merchantName;
                document.getElementById('lbl-shop').textContent = dynamicShopDetails.shopName;
                document.getElementById('lbl-city').textContent = dynamicShopDetails.cityName;
                
                // Populate the new Address Warning box
                document.getElementById('lbl-address').textContent = dynamicShopDetails.shopAddress;

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('checkout-content').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("Error loading payment details: " + err.message);
                window.location.href = "merchant-dashboard.html";
            }
        }

        // --- PAYSTACK FLOW ---
        function payWithPaystack() {
            if (!dynamicShopDetails) return;
            const amountInKobo = FEE_AMOUNT * 100;
            
            let handler = PaystackPop.setup({
                // üõë REPLACE THIS WITH YOUR PAYSTACK PUBLIC KEY
                key: 'pk_test_f681256d9c1bc10964457c68fb2381e6451ed2b9', 
                email: dynamicShopDetails.email,
                amount: amountInKobo,
                currency: 'NGN',
                ref: "CTM-VERIFY-" + Date.now(),
                callback: function(response) {
                    document.getElementById('processing-overlay').classList.remove('hidden');
                    verifyPaymentOnBackend(response.reference, 'paystack');
                },
                onClose: function() { console.log('Paystack window closed.'); }
            });
            handler.openIframe();
        }

        // --- REMITA FLOW ---
        function payWithRemita() {
            if (!dynamicShopDetails) return;
            
            const transactionId = "CTM-VERIFY-" + Date.now(); 
            const names = dynamicShopDetails.merchantName.split(' ');
            const firstName = names[0];
            const lastName = names.slice(1).join(' ') || "Merchant";

            var paymentEngine = RmPaymentEngine.init({
                key: "QzAwMDAyNzEyNTl8MTEwNjE4Njc3NzR8M2RjY2NlYTg4YzhjNWQzMTc4ZTA1NTZkYmViYzhmOTQzM2I0ZTU2Y2Q5Y2E4OWM1ZGI0MjI1YTUzYTNhZjJhMzk1YjcwZWQ3N2ZhMWQwZWM4M2IwZDMyZDUxZTZhNTBiZjZiYTgxMGI1MGEyZTIwMWQxZDRhZDFhMTU4MjZhNTc=", 
                customerId: dynamicShopDetails.email,
                firstName: firstName,
                lastName: lastName,
                email: dynamicShopDetails.email,
                amount: FEE_AMOUNT,
                narration: "CT-Merchant Physical Verification",
                transactionId: transactionId,
                
                onSuccess: function (response) {
                    document.getElementById('processing-overlay').classList.remove('hidden');
                    verifyPaymentOnBackend(response.transactionId, 'remita');
                },
                onError: function (response) { alert("Payment failed or cancelled."); },
                onClose: function () { console.log("Remita window closed"); }
            });

            paymentEngine.showPaymentWidget();
        }

        // --- SECURE BACKEND VERIFICATION ---
        async function verifyPaymentOnBackend(txId, gateway) {
            try {
                document.getElementById('gateway-buttons').style.display = 'none';

                const response = await fetch(`${SUPABASE_URL}/functions/v1/verify-remita`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUserSession.access_token}`,
                        'apikey': SUPABASE_ANON_KEY 
                    },
                    body: JSON.stringify({ 
                        transactionId: txId,
                        merchantName: dynamicShopDetails.merchantName,
                        shopName: dynamicShopDetails.shopName,
                        cityName: dynamicShopDetails.cityName,
                        gateway: gateway 
                    })
                });

                const result = await response.json();

                if (!response.ok) throw new Error(result.error || "Verification failed");

                document.getElementById('processing-overlay').classList.add('hidden');
                
                // NEW SUCCESS MESSAGE
                document.getElementById('status-msg').innerHTML = `‚úÖ Payment Successful! Generating receipt and dispatching agent...`;
                
                setTimeout(() => {
                    window.location.href = "merchant-dashboard.html";
                }, 3500);

            } catch (error) {
                console.error(error);
                document.getElementById('processing-overlay').classList.add('hidden');
                document.getElementById('status-msg').innerHTML = "‚ö†Ô∏è " + error.message;
                document.getElementById('status-msg').style.color = "#DC2626";
                document.getElementById('gateway-buttons').style.display = 'block'; 
            }
        }
    </script>
</body>
</html>

