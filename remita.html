<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remita Payment | CT-Merchant</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://remitademo.net/payment/v1/remita-pay-inline.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F3F4F6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .checkout-card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; }
        .price { font-size: 2.5rem; font-weight: 800; color: #0F172A; margin: 10px 0; }
        .btn-pay { background: #059669; color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; margin-top: 20px; }
        .btn-pay:hover { background: #047857; }
        .btn-pay:disabled { background: #9CA3AF; cursor: not-allowed; }
        #status-msg { margin-top: 15px; font-size: 0.9rem; font-weight: 600; color: #059669; }
    </style>
</head>
<body>

    <div class="checkout-card">
        <h2 style="margin-top: 0; color: #475569; font-size: 1.2rem;">Physical Verification Fee</h2>
        <div class="price">₦5,000</div>
        <p style="color: #64748b; font-size: 0.95rem;">One-time payment to dispatch an agent to verify your shop.</p>

        <button id="pay-btn" class="btn-pay" onclick="makePayment()">Pay with Remita</button>
        <div id="status-msg"></div>
    </div>

    <script>
        // Setup Supabase (Replace with your actual keys)
        const SUPABASE_URL = "https://xdchacdjcgazyckacbpc.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDA2MzMsImV4cCI6MjA4NTExNjYzM30.41V3RaUX-ii-EHysbcVpUCgm0-RsNmuOb8FmYsz72Ow";
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Dummy data for testing. In production, pull this from local storage or URL params
        const shopDetails = {
            merchantName: "Alex Doe",
            shopName: "Alex Electronics",
            cityName: "Kaduna",
            email: "merchant@example.com"
        };

        function makePayment() {
            const amount = 5000;
            const transactionId = "CTM-" + Date.now(); 

            var paymentEngine = RmPaymentEngine.init({
                key: "QzAwMDAyNzEyNTl8MTEwNjE4Njc3NzR8M2RjY2NlYTg4YzhjNWQzMTc4ZTA1NTZkYmViYzhmOTQzM2I0ZTU2Y2Q5Y2E4OWM1ZGI0MjI1YTUzYTNhZjJhMzk1YjcwZWQ3N2ZhMWQwZWM4M2IwZDMyZDUxZTZhNTBiZjZiYTgxMGI1MGEyZTIwMWQxZDRhZDFhMTU4MjZhNTc=", 
                customerId: shopDetails.email,
                firstName: shopDetails.merchantName.split(' ')[0],
                lastName: shopDetails.merchantName.split(' ')[1] || "",
                email: shopDetails.email,
                amount: amount,
                narration: "CT-Merchant Physical Verification",
                transactionId: transactionId,
                
                onSuccess: function (response) {
                    console.log('Payment successful: ', response);
                    document.getElementById('pay-btn').style.display = 'none';
                    document.getElementById('status-msg').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying payment securely...';
                    
                    verifyPaymentOnBackend(response.transactionId);
                },
                
                onError: function (response) {
                    console.log('Payment failed: ', response);
                    alert("Payment failed. Please try again.");
                },
                onClose: function () {
                    console.log("Widget closed");
                }
            });

            paymentEngine.showPaymentWidget();
        }

        async function verifyPaymentOnBackend(txId) {
            try {
                const { data: { session } } = await client.auth.getSession();
                if (!session) throw new Error("You must be logged in.");

                // Call our Edge Function and pass the shop details!
                const response = await fetch(`${SUPABASE_URL}/functions/v1/verify-remita`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`,
                        'apikey': SUPABASE_ANON_KEY 
                    },
                    body: JSON.stringify({ 
                        transactionId: txId,
                        merchantName: shopDetails.merchantName,
                        shopName: shopDetails.shopName,
                        cityName: shopDetails.cityName
                    })
                });

                const result = await response.json();

                if (!response.ok) throw new Error(result.error || "Verification failed");

                document.getElementById('status-msg').innerHTML = "✅ Payment verified! Receipt generated.";
                document.getElementById('status-msg').style.color = "#059669";
                
                // Optional: Redirect to a success page after 2 seconds
                // setTimeout(() => window.location.href = "merchant-dashboard.html", 2000);

            } catch (error) {
                console.error(error);
                document.getElementById('status-msg').innerHTML = "⚠️ " + error.message;
                document.getElementById('status-msg').style.color = "#DC2626";
                document.getElementById('pay-btn').style.display = 'block';
            }
        }
    </script>
</body>
</html>