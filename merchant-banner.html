<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Banners | CTâ€‘Merchant</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --color-purple: #2E1065;
            --color-bg: #F8FAFC;
            --color-text: #1E293B;
            --color-border: #E2E8F0;
            --color-red: #EF4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--color-bg); color: var(--color-text); min-height: 100vh; display: flex; justify-content: center; padding: 20px; }

        .container { width: 100%; max-width: 500px; }

        /* Header */
        .app-bar { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .back-btn { background: white; border: 1px solid var(--color-border); width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--color-text); font-size: 1.1rem; }
        .page-title { font-size: 1.25rem; font-weight: 800; }
        
        /* Save Button */
        .save-btn {
            margin-left: auto; background: none; border: none; color: var(--color-purple);
            font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 6px;
        }
        .save-btn:disabled { color: #94A3B8; cursor: not-allowed; }

        /* Instructions */
        .info-box { margin-bottom: 24px; }
        .info-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; }
        .info-desc { color: #64748B; font-size: 0.9rem; }

        /* Banner List */
        .banner-list { display: flex; flex-direction: column; gap: 16px; }

        .banner-item {
            position: relative; width: 100%; height: 180px;
            border-radius: 16px; overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            background: white; border: 1px solid var(--color-border);
        }
        .banner-img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Status Badges */
        .status-badge {
            position: absolute; top: 12px; left: 12px;
            font-size: 0.75rem; font-weight: 800; padding: 6px 12px; 
            border-radius: 8px; z-index: 10; backdrop-filter: blur(4px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-pending { background: rgba(254, 243, 199, 0.9); color: #D97706; border: 1px solid #FDE68A; }
        .status-approved { background: rgba(209, 250, 229, 0.9); color: #059669; border: 1px solid #A7F3D0; }
        .status-rejected { background: rgba(254, 226, 226, 0.9); color: #DC2626; border: 1px solid #FECACA; }
        .status-new { background: rgba(224, 231, 255, 0.9); color: #4F46E5; border: 1px solid #C7D2FE; }

        .delete-btn {
            position: absolute; top: 10px; right: 10px;
            background: white; color: var(--color-red);
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s; z-index: 10;
        }
        .delete-btn:hover { transform: scale(1.1); background: #FEF2F2; }

        /* Add Button */
        .add-card {
            width: 100%; height: 180px; background: #F1F5F9;
            border: 2px dashed #CBD5E1; border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; color: #64748B;
        }
        .add-card:hover { border-color: var(--color-purple); background: #F3E8FF; color: var(--color-purple); }
        .add-icon { font-size: 2rem; margin-bottom: 8px; }
        .add-text { font-weight: 600; font-size: 0.9rem; }

        .spinner { width: 20px; height: 20px; border: 2px solid rgba(46, 16, 101, 0.2); border-top-color: var(--color-purple); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="app-bar">
        <button onclick="history.back()" class="back-btn"><i class="fa-solid fa-arrow-left"></i></button>
        <div class="page-title">Shop Banners</div>
        <button id="save-btn" onclick="saveBanners()" class="save-btn">
            <i class="fa-solid fa-check"></i> Save
        </button>
    </div>

    <div class="info-box">
        <div class="info-title">Upload up to 2 Banners</div>
        <div class="info-desc">High quality landscape images work best. New banners will be reviewed by an admin before going live.</div>
    </div>

    <div id="banner-container" class="banner-list">
        <!-- JS Populated -->
    </div>

    <input type="file" id="file-input" hidden accept="image/*" onchange="handleFileSelect(this)">
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = "https://xdchacdjcgazyckacbpc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDA2MzMsImV4cCI6MjA4NTExNjYzM30.41V3RaUX-ii-EHysbcVpUCgm0-RsNmuOb8FmYsz72Ow";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(window.location.search);
    const shopId = params.get('shop_id');
    let currentUser = null;
    
    // Array of objects holding state for each banner
    let bannerSlots = []; 

    window.onload = async () => {
        const { data: { session } } = await client.auth.getSession();
        if (!session) { window.location.href = "login.html"; return; }
        currentUser = session.user;
        
        if (!shopId) { alert("Shop ID missing"); window.history.back(); return; }

        // Fetch current banners from the NEW shop_banners_news table
        const { data, error } = await client
            .from('shop_banners_news')
            .select('id, content_data, status')
            .eq('shop_id', shopId)
            .eq('content_type', 'banner')
            .order('created_at', { ascending: true });
        
        if (data && data.length > 0) {
            bannerSlots = data.map(b => ({
                id: b.id,            // Database ID
                url: b.content_data,// Image URL
                file: null,         // No file because it's already uploaded
                status: b.status,   // pending, approved, or rejected
                isDeleted: false
            }));
        }
        renderBanners();
    };

    function renderBanners() {
        const container = document.getElementById('banner-container');
        container.innerHTML = '';

        const activeBanners = bannerSlots.filter(b => !b.isDeleted);

        activeBanners.forEach((item) => {
            const displayUrl = item.file ? URL.createObjectURL(item.file) : item.url;
            const realIndex = bannerSlots.indexOf(item);
            
            // Determine badge appearance
            let badgeHTML = '';
            if (item.file) {
                badgeHTML = `<div class="status-badge status-new">NEW - UNSAVED</div>`;
            } else if (item.status === 'pending') {
                badgeHTML = `<div class="status-badge status-pending">PENDING APPROVAL</div>`;
            } else if (item.status === 'approved') {
                badgeHTML = `<div class="status-badge status-approved">APPROVED</div>`;
            } else if (item.status === 'rejected') {
                badgeHTML = `<div class="status-badge status-rejected">REJECTED</div>`;
            }

            const div = document.createElement('div');
            div.className = 'banner-item';
            div.innerHTML = `
                <img src="${displayUrl}" class="banner-img">
                ${badgeHTML}
                <button class="delete-btn" onclick="removeBanner(${realIndex})">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            `;
            container.appendChild(div);
        });

        // Render Add Button if < 2 active banners
        if (activeBanners.length < 2) {
            const addBtn = document.createElement('div');
            addBtn.className = 'add-card';
            addBtn.onclick = () => document.getElementById('file-input').click();
            addBtn.innerHTML = `
                <i class="fa-solid fa-images add-icon"></i>
                <div class="add-text">Tap to add banner</div>
            `;
            container.appendChild(addBtn);
        }
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            bannerSlots.push({
                id: null,
                url: null,
                file: input.files[0],
                status: 'pending',
                isDeleted: false
            });
            renderBanners();
            input.value = ''; // Reset input
        }
    }

    function removeBanner(index) {
        bannerSlots[index].isDeleted = true;
        renderBanners();
    }

    async function saveBanners() {
        const btn = document.getElementById('save-btn');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div>';

        try {
            // 1. Delete removed banners from Database and Storage
            const toDelete = bannerSlots.filter(b => b.isDeleted && b.id !== null);
            for (let b of toDelete) {
                // Delete from DB
                await client.from('shop_banners_news').delete().eq('id', b.id);
                
                // Extract path and delete from storage
                const parts = b.url.split('/banner-storage/');
                if (parts.length > 1) {
                    await client.storage.from('banner-storage').remove([parts[1]]);
                }
            }

            // 2. Upload new files and Insert to Database
            const toUpload = bannerSlots.filter(b => !b.isDeleted && b.file !== null);
            for (let b of toUpload) {
                const ext = b.file.name.split('.').pop();
                const fileName = `${shopId}/${Date.now()}_${Math.random()}.${ext}`;
                
                // Upload to Storage
                const { error: uploadError } = await client.storage
                    .from('banner-storage')
                    .upload(fileName, b.file);

                if (uploadError) throw uploadError;

                const { data } = client.storage.from('banner-storage').getPublicUrl(fileName);
                
                // Insert into Approval Database
                const { error: dbError } = await client.from('shop_banners_news').insert({
                    shop_id: shopId,
                    merchant_id: currentUser.id,
                    content_type: 'banner',
                    content_data: data.publicUrl,
                    status: 'pending' // Goes to the pending queue for admins
                });

                if (dbError) throw dbError;
            }

            alert("Banners updated! New banners have been sent for admin approval.");
            window.history.back();

        } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Save';
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
