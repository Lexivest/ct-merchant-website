<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account | CTâ€‘Merchant</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --color-primary: #6B21A8; /* AppColors.primary - Purple */
            --color-accent: #EC4899; /* AppColors.accent - Pink */
            --color-bg: #F9FAFB;
            --color-text: #111827;
            --color-text-light: #6B7280;
            --color-error: #EF4444;
            --color-success: #10B981;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .auth-card {
            background: white;
            width: 100%;
            max-width: 480px;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            border-radius: 1rem;
            margin-bottom: 1rem;
            object-fit: cover;
        }

        .auth-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: var(--color-text-light);
            font-size: 0.95rem;
        }

        .form-stack {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            color: var(--color-text-light);
            font-size: 1.1rem;
        }

        .auth-input {
            width: 100%;
            padding: 0.85rem 1rem 0.85rem 3rem;
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s;
            background: #FDFDFD;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(107, 33, 168, 0.1);
            background: white;
        }

        select.auth-input {
            padding-left: 3rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2rem;
        }

        .pass-toggle {
            position: absolute;
            right: 1rem;
            background: none;
            border: none;
            color: var(--color-text-light);
            cursor: pointer;
            padding: 0.25rem;
        }

        .checkbox-group {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            margin-top: 0.5rem;
        }

        .checkbox-group input {
            width: 1.2rem;
            height: 1.2rem;
            accent-color: var(--color-primary);
            cursor: pointer;
            margin-top: 0.1rem;
        }

        .checkbox-label {
            font-size: 0.85rem;
            color: var(--color-text-light);
            line-height: 1.4;
        }

        .link-highlight {
            color: var(--color-primary);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            border: none;
            background: none;
        }

        .link-highlight:hover {
            text-decoration: underline;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
        }

        .footer-link {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: var(--color-text-light);
        }

        .status-box {
            display: none;
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            text-align: center;
        }

        .status-box.active {
            display: block;
        }

        .status-error {
            background-color: #FEF2F2;
            color: var(--color-error);
            border: 1px solid #FEE2E2;
        }

        .status-success {
            background-color: #ECFDF5;
            color: var(--color-success);
            border: 1px solid #D1FAE5;
        }

        /* Loading Spinner */
        .spinner {
            width: 1.2rem;
            height: 1.2rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden { display: none !important; }

        @media (max-width: 480px) {
            .auth-card {
                padding: 1.5rem;
                border-radius: 0;
                box-shadow: none;
            }
            body { padding: 0; background: white; }
        }
    </style>
</head>
<body>

    <div class="auth-card">
        <div class="auth-header">
            <img src="https://goodtvrhszsnhcyigfoi.supabase.co/storage/v1/object/public/ctm_web_files/CT-Merchant.jpg" alt="CTM Logo" class="auth-logo">
            <h2 class="auth-title">Create Account</h2>
            <p class="auth-subtitle">Join the professional merchant network.</p>
        </div>

        <form id="signup-form" class="form-stack">
            <!-- Full Name -->
            <div class="input-group">
                <label class="input-label">Full Name</label>
                <div class="input-wrapper">
                    <span class="input-icon"><i class="fa-solid fa-user"></i></span>
                    <input type="text" id="signup-name" placeholder="John Doe" required class="auth-input">
                </div>
            </div>

            <!-- Phone -->
            <div class="input-group">
                <label class="input-label">Phone Number</label>
                <div class="input-wrapper">
                    <span class="input-icon"><i class="fa-solid fa-phone"></i></span>
                    <input type="tel" id="signup-phone" placeholder="08012345678" required class="auth-input">
                </div>
            </div>

            <!-- Email -->
            <div class="input-group">
                <label class="input-label">Email Address</label>
                <div class="input-wrapper">
                    <span class="input-icon"><i class="fa-solid fa-envelope"></i></span>
                    <input type="email" id="signup-email" placeholder="name@email.com" required class="auth-input">
                </div>
            </div>

            <!-- City Selection -->
            <div class="input-group">
                <label class="input-label">Select City</label>
                <div class="input-wrapper">
                    <span class="input-icon"><i class="fa-solid fa-city"></i></span>
                    <select id="signup-city" class="auth-input" required>
                        <option value="" disabled selected>Loading cities...</option>
                    </select>
                </div>
            </div>

            <!-- Area Selection -->
            <div class="input-group">
                <label class="input-label">Select Area</label>
                <div class="input-wrapper">
                    <span class="input-icon"><i class="fa-solid fa-map-pin"></i></span>
                    <select id="signup-area" class="auth-input" required disabled>
                        <option value="" disabled selected>Select a city first</option>
                    </select>
                </div>
            </div>

            <!-- Password -->
            <div class="input-group">
                <label class="input-label">Password</label>
                <div class="input-wrapper">
                    <span class="input-icon"><i class="fa-solid fa-lock"></i></span>
                    <input type="password" id="signup-password" placeholder="Min 6 characters" required class="auth-input">
                    <button type="button" onclick="togglePasswordVisibility()" class="pass-toggle">
                        <i id="eye-icon" class="fa-solid fa-eye"></i>
                    </button>
                </div>
            </div>

            <!-- Agreement -->
            <div class="checkbox-group">
                <input type="checkbox" id="terms-check">
                <label for="terms-check" class="checkbox-label">
                    I agree to the <a href="terms.html" class="link-highlight">Terms of Service</a> and 
                    <a href="privacy.html" class="link-highlight">Privacy Policy</a>.
                </label>
            </div>

            <button type="submit" id="submit-btn" class="btn-primary">
                <span>Create Account</span>
            </button>
        </form>

        <div id="status-message" class="status-box"></div>

        <div class="footer-link">
            <p>Already have an account? <a href="login.html" class="link-highlight">Sign In</a></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://xdchacdjcgazyckacbpc.supabase.co"; // Matches app's project URL
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDA2MzMsImV4cCI6MjA4NTExNjYzM30.41V3RaUX-ii-EHysbcVpUCgm0-RsNmuOb8FmYsz72Ow";
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const citySelect = document.getElementById('signup-city');
        const areaSelect = document.getElementById('signup-area');
        const signupForm = document.getElementById('signup-form');
        const submitBtn = document.getElementById('submit-btn');
        const statusMsg = document.getElementById('status-message');

        // Initial Load
        window.onload = () => {
            fetchCities();
        };

        async function fetchCities() {
            try {
                const { data, error } = await client
                    .from('cities')
                    .select('id, name')
                    .order('name', { ascending: true });

                if (error) throw error;

                citySelect.innerHTML = '<option value="" disabled selected>Select your city</option>';
                data.forEach(city => {
                    const opt = document.createElement('option');
                    opt.value = city.id;
                    opt.textContent = city.name;
                    citySelect.appendChild(opt);
                });
            } catch (err) {
                console.error("Error fetching cities:", err);
                citySelect.innerHTML = '<option value="" disabled>Error loading cities</option>';
            }
        }

        citySelect.addEventListener('change', async (e) => {
            const cityId = e.target.value;
            areaSelect.disabled = true;
            areaSelect.innerHTML = '<option value="" disabled selected>Loading areas...</option>';

            try {
                const { data, error } = await client
                    .from('areas')
                    .select('id, name')
                    .eq('city_id', cityId)
                    .order('name', { ascending: true });

                if (error) throw error;

                areaSelect.innerHTML = '<option value="" disabled selected>Select your area</option>';
                data.forEach(area => {
                    const opt = document.createElement('option');
                    opt.value = area.id;
                    opt.textContent = area.name;
                    areaSelect.appendChild(opt);
                });
                areaSelect.disabled = false;
            } catch (err) {
                console.error("Error fetching areas:", err);
                areaSelect.innerHTML = '<option value="" disabled>Error loading areas</option>';
            }
        });

        function togglePasswordVisibility() {
            const input = document.getElementById('signup-password');
            const icon = document.getElementById('eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
                icon.style.color = 'var(--color-accent)';
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
                icon.style.color = '';
            }
        }

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('signup-name').value;
            const phone = document.getElementById('signup-phone').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const cityId = citySelect.value;
            const areaId = areaSelect.value;
            const agreed = document.getElementById('terms-check').checked;

            if (!agreed) {
                showStatus("Please agree to the Terms & Privacy Policy", "error");
                return;
            }

            setLoading(true);

            try {
                // 1. SIGN UP USER
                const { data: authData, error: authError } = await client.auth.signUp({
                    email: email,
                    password: password
                });

                if (authError) throw authError;

                if (authData.user) {
                    // 2. CREATE PROFILE RECORD
                    const { error: profileError } = await client.from('profiles').insert({
                        id: authData.user.id,
                        full_name: name,
                        phone: phone,
                        city_id: parseInt(cityId),
                        area_id: parseInt(areaId)
                    });

                    if (profileError) throw profileError;

                    showStatus("Account created successfully! Redirecting...", "success");
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
            } catch (err) {
                console.error("Signup failed:", err);
                showStatus(getHumanError(err), "error");
                setLoading(false);
            }
        });

        function showStatus(msg, type) {
            statusMsg.textContent = msg;
            statusMsg.className = `status-box active status-${type}`;
        }

        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner"></div> Processing...';
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Create Account</span>';
            }
        }

        // Logic from SupabaseService Flutter class
        function getHumanError(err) {
            const msg = err.message || err.toString();
            if (msg.includes("User already registered")) return "An account with this email already exists.";
            if (msg.includes("Invalid login credentials")) return "Invalid email or password.";
            if (msg.includes("Network")) return "No internet connection. Please check your network.";
            return msg;
        }
    </script>
</body>
</html>
