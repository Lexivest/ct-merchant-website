<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marketplace | CT-Merchant</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            /* --- THEME --- */
            --color-primary: #059669; /* Emerald Green */
            --color-primary-dark: #047857;
            --color-accent: #FFFFFF; /* White for header text */
            --color-bg: #F3F4F6;
            --color-text-main: #1F2937;
            
            --sidebar-width: 280px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--color-bg); 
            color: var(--color-text-main);
            overflow-x: hidden;
        }

        /* --- 1. SIDEBAR (Universal Overlay) --- */
        .sidebar {
            position: fixed; top: 0; left: 0; bottom: 0;
            width: var(--sidebar-width);
            background: white;
            z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }

        body.sb-open .sidebar { transform: translateX(0); }

        .sidebar-header {
            height: var(--header-height);
            background: var(--color-primary);
            color: white;
            display: flex; align-items: center; gap: 12px; padding: 0 20px;
        }
        
        .sidebar-logo { width: 36px; height: 36px; border-radius: 8px; object-fit: cover; background: white; border: 2px solid white; }

        .nav-scroll { flex: 1; padding: 16px; overflow-y: auto; }
        .nav-btn {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px; width: 100%; border: none; background: none;
            color: #4B5563; font-weight: 600; font-size: 0.95rem;
            border-radius: 8px; cursor: pointer; transition: 0.2s; text-align: left; margin-bottom: 4px;
        }
        .nav-btn:hover { background: #F3F4F6; color: var(--color-primary); }
        .nav-btn.active { background: #ECFDF5; color: var(--color-primary); }
        .nav-btn i { width: 24px; text-align: center; }

        .sidebar-footer { padding: 16px; border-top: 1px solid #E5E7EB; }

        /* --- 2. BACKDROP OVERLAY --- */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1500;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        body.sb-open .overlay { opacity: 1; visibility: visible; }

        /* --- 3. HEADER (Fixed, Single Row) --- */
        .top-header {
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 1000;
            background: var(--color-primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: var(--header-height);
        }

        .header-main {
            height: 100%;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px;
            max-width: 1400px; margin: 0 auto;
        }
        
        /* Left Section */
        .header-left { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .menu-toggle { background: none; border: none; color: white; font-size: 1.4rem; padding: 8px; cursor: pointer; }
        .header-city { font-weight: 700; font-size: 1rem; color: white; white-space: nowrap; }

        /* Center Section (Ticker) */
        .header-ticker {
            flex: 1;
            margin: 0 16px;
            overflow: hidden;
            display: flex;
            align-items: center;
            height: 100%;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .ticker-content {
            white-space: nowrap; 
            animation: ticker 60s linear infinite;
            color: white; 
            font-weight: 600; 
            font-size: 0.9rem; 
            padding-left: 100%;
        }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* Right Section */
        .header-actions { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        
        .action-btn { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; }
        .notif-wrap { position: relative; cursor: pointer; color: white; }
        .notif-badge {
            position: absolute; top: -4px; right: -4px;
            background: #EF4444; color: white; font-size: 0.65rem; font-weight: 800;
            padding: 2px 4px; border-radius: 10px; border: 1.5px solid var(--color-primary);
            display: none;
        }

        /* --- 4. CONTENT BODY --- */
        .content-body {
            margin-top: var(--header-height);
            padding: 0 0 40px 0;
            max-width: 1400px; margin-left: auto; margin-right: auto;
            width: 100%;
        }
        @media (min-width: 1024px) { .content-body { padding: 20px; } }

        /* --- UTILS --- */
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* COMPACT SPACING STYLES */
        .sec-header { 
            display: flex; align-items: center; gap: 10px; 
            padding: 6px 16px 2px 16px; 
            margin: 0; 
            background: var(--color-bg); 
        }
        .sec-bar { width: 4px; height: 18px; border-radius: 4px; }
        .sec-title { font-size: 1.05rem; font-weight: 800; color: #111827; }

        .h-scroll {
            display: flex; overflow-x: auto; gap: 12px; 
            padding: 0 16px 4px 16px;
            scrollbar-width: thin; scrollbar-color: #CBD5E1 transparent;
        }
        .h-scroll::-webkit-scrollbar { height: 0px; }

        .shop-card {
            min-width: 220px; width: 220px;
            background: white; border-radius: 12px;
            border: 1px solid #E5E7EB; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer;
            display: flex; flex-direction: column; flex-shrink: 0;
            transition: transform 0.2s;
        }
        .shop-card:active { transform: scale(0.98); }

        .img-box { height: 140px; width: 100%; background: #F1F5F9; }
        
        .collage { width: 100%; height: 100%; display: flex; flex-wrap: wrap; }
        .collage img { object-fit: cover; display: block; box-sizing: border-box; border: 0.5px solid white; }
        .c-1 img { width: 100%; height: 100%; border: none; }
        .c-2 img { width: 50%; height: 100%; }
        .c-3 { display: flex; }
        .c-3 > img:first-child { width: 50%; height: 100%; }
        .c-3 > div { width: 50%; height: 100%; display: flex; flex-direction: column; }
        .c-3 > div img { width: 100%; height: 50%; }
        .c-4 img { width: 50%; height: 50%; }

        .info-box { padding: 10px; }
        .s-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* UPDATED: CT ID Style */
        .s-id-badge { 
            display: inline-block; 
            font-size: 0.7rem; 
            font-weight: 700; 
            color: #1E40AF; /* Dark Blue */
            background: #EFF6FF; /* Light Blue */
            padding: 2px 6px; 
            border-radius: 4px; 
            border: 1px solid #DBEAFE;
            margin-bottom: 6px; 
        }

        .s-loc { font-size: 0.75rem; color: #6B7280; display: flex; align-items: center; gap: 4px; }

        /* Areas */
        .area-container { margin-bottom: 0; padding-bottom: 0; }
        .area-pill { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 12px; border-radius: 8px; 
            margin: 4px 16px 4px 16px; 
        }
        .area-pill.user { background: #DCFCE7; }
        .area-pill.other { background: #FEF3C7; }
        .pill-left { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.95rem; color: #1F2937; }

        .cat-grid { display: flex; flex-wrap: wrap; gap: 8px; padding: 0 16px 8px 16px; }
        .cat-chip {
            background: white; border: 1px solid #E5E7EB; border-radius: 50px;
            padding: 6px 14px 6px 6px; display: flex; align-items: center; gap: 8px;
            cursor: pointer; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .cat-chip img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid #E5E7EB; }
        .cat-chip span { font-size: 0.85rem; font-weight: 700; color: #374151; }

        .shop-grid-view { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 12px; padding: 0 16px 20px 16px;
        }
        .svc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; padding: 20px 16px; }
        .svc-card {
            background: white; padding: 20px 16px; border-radius: 12px; text-align: center;
            border: 1px solid #E5E7EB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer;
            transition: transform 0.2s;
        }
        .svc-card:active { transform: scale(0.96); }
        .svc-icon { width: 48px; height: 48px; border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        /* Form Styles */
        .form-group { margin-bottom: 16px; text-align: left; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #374151; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; }
        .form-input:focus { outline: none; border-color: var(--color-primary); ring: 2px solid #A7F3D0; }
    </style>
</head>
<body>

    <!-- OVERLAY (Universal) -->
    <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="https://goodtvrhszsnhcyigfoi.supabase.co/storage/v1/object/public/ctm_web_files/CT-Merchant.jpg" class="sidebar-logo" alt="Logo">
            <span style="font-weight: 800; font-size: 1.1rem; margin-left: 10px;">CT-MERCHANT</span>
        </div>
        
        <div class="nav-scroll">
            <button class="nav-btn active" onclick="switchScreen('market', this)">
                <i class="fa-solid fa-store"></i> Market Overview
            </button>
            <button class="nav-btn" onclick="switchScreen('services', this)">
                <i class="fa-solid fa-table-cells-large"></i> Services
            </button>
            <button class="nav-btn" onclick="switchScreen('profile', this)">
                <i class="fa-solid fa-user-gear"></i> My Profile
            </button>
            <button class="nav-btn" onclick="switchScreen('notifications', this)">
                <i class="fa-solid fa-bell"></i> Notifications
            </button>
        </div>
        
        <div class="sidebar-footer">
            <button class="nav-btn" style="color: #EF4444;" onclick="handleLogout()">
                <i class="fa-solid fa-right-from-bracket"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- HEADER (Single Row) -->
    <header class="top-header">
        <div class="header-main">
            <!-- Left: Toggle & City -->
            <div class="header-left">
                <button class="menu-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                <div id="header-city" class="header-city">...</div>
            </div>
            
            <!-- Middle: Ticker -->
            <div id="header-ticker" class="header-ticker" style="display:none;">
                <div id="ticker-text" class="ticker-content"></div>
            </div>
            
            <!-- Right: Actions -->
            <div class="header-actions">
                <button class="action-btn" onclick="window.location.href='shop-index.html'" title="Shop Index">
                    <i class="fa-solid fa-arrow-down-a-z" style="font-size: 1.1rem;"></i>
                </button>
                
                <div class="notif-wrap" onclick="switchScreen('notifications', document.querySelectorAll('.nav-btn')[3])">
                    <i class="fa-regular fa-bell" style="font-size:1.3rem;"></i>
                    <div id="badge-count" class="notif-badge">0</div>
                </div>
                
                <img id="header-avatar" src="" style="width:34px; height:34px; border-radius:50%; border:2px solid rgba(255,255,255,0.5); object-fit:cover; background:#ccc; cursor:pointer;" onclick="switchScreen('profile', document.querySelectorAll('.nav-btn')[2])">
            </div>
        </div>
    </header>

    <!-- CONTENT BODY -->
    <main class="content-body">
        
        <!-- MARKET -->
        <div id="market" class="screen active">
            <!-- Promos -->
            <div id="promo-list" class="h-scroll" style="display:none; padding-top:8px;"></div>
            
            <!-- Featured -->
            <div id="featured-section" style="display:none;">
                <div class="sec-header">
                    <div class="sec-bar" style="background: orange;"></div>
                    <div class="sec-title">Featured Shops</div>
                </div>
                <div id="featured-list" class="h-scroll"></div>
            </div>

            <!-- Areas -->
            <div id="areas-container" style="margin-top:0;">
                <div id="initial-loader" style="text-align:center; padding:60px 0; color:#CBD5E1;">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2rem;"></i>
                </div>
            </div>

            <!-- Categories -->
            <div class="sec-header">
                <div class="sec-bar" style="background: var(--color-primary);"></div>
                <div class="sec-title">Browse Categories</div>
            </div>
            <div id="category-list" class="cat-grid"></div>

            <!-- All Shops -->
            <div class="sec-header">
                <div class="sec-bar" style="background: #374151;"></div>
                <div class="sec-title">All Shops</div>
            </div>
            <div id="all-shops-grid" class="shop-grid-view"></div>
        </div>

        <!-- SERVICES -->
        <div id="services" class="screen">
            <h2 class="sec-title" style="margin: 16px 16px 0 16px;">Services & Tools</h2>
            <div class="svc-grid">
                
                <!-- MY SHOP DYNAMIC CARD -->
                <div id="myshop-card" class="svc-card" onclick="handleShopClick()">
                    <div class="svc-icon" style="background:#F3F4F6; color:#9CA3AF;"><i class="fa-solid fa-store"></i></div>
                    <strong>Loading...</strong>
                </div>

                <div class="svc-card" onclick="window.location.href='wishlist.html'">
                    <div class="svc-icon" style="background:#FCE7F3; color:#DB2777;"><i class="fa-solid fa-heart"></i></div>
                    <strong>Wishlist</strong>
                </div>
                <div class="svc-card" onclick="window.location.href='help-support.html'">
                    <div class="svc-icon" style="background:#DCFCE7; color:#10B981;"><i class="fa-solid fa-headset"></i></div>
                    <strong>Support</strong>
                </div>
                <div class="svc-card" onclick="window.location.href='faq.html'">
                    <div class="svc-icon" style="background:#E0E7FF; color:#4338CA;"><i class="fa-solid fa-circle-question"></i></div>
                    <strong>FAQ</strong>
                </div>
                <div class="svc-card" onclick="window.location.href='report-abuse.html'">
                    <div class="svc-icon" style="background:#FEE2E2; color:#DC2626;"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <strong>Report Abuse</strong>
                </div>
            </div>
        </div>

        <!-- PROFILE -->
        <div id="profile" class="screen">
            <!-- View Mode -->
            <div id="profile-view" style="max-width:600px; margin:20px auto; background:white; padding:40px; border-radius:16px; border:1px solid #E5E7EB; text-align:center;">
                <img id="profile-avatar-lg" src="" style="width:100px; height:100px; border-radius:50%; margin-bottom:16px; border:4px solid var(--color-primary); object-fit: cover;">
                <h2 id="profile-name" style="font-size:1.5rem; color:#111827;">Loading...</h2>
                <p id="profile-phone" style="color:#6B7280; font-weight:500; margin-bottom:4px;"></p>
                <p id="profile-email" style="color:#9CA3AF; margin-bottom:20px; font-size:0.9rem;">...</p>
                
                <div style="display:flex; justify-content:center; gap:10px;">
                    <button onclick="openEditProfile()" style="background:var(--color-primary); color:white; border:none; padding:10px 24px; border-radius:8px; font-weight:700; cursor:pointer;">
                        <i class="fa-solid fa-pen-to-square"></i> Edit Profile
                    </button>
                </div>
            </div>

            <!-- Edit Mode -->
            <div id="profile-edit" style="display:none; max-width:600px; margin:20px auto; background:white; padding:30px; border-radius:16px; border:1px solid #E5E7EB;">
                <h3 style="margin-bottom:20px; font-size:1.2rem; border-bottom:1px solid #E5E7EB; padding-bottom:10px;">Edit Profile</h3>
                
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="edit-name" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" id="edit-phone" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">City</label>
                    <select id="edit-city" onchange="handleCityChange(this.value)" class="form-input" style="background:white;">
                        <option value="">Select City</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom:24px;">
                    <label class="form-label">Area</label>
                    <select id="edit-area" class="form-input" style="background:white;">
                        <option value="">Select Area</option>
                    </select>
                </div>
                
                <p id="edit-error" style="color:#EF4444; font-size:0.9rem; margin-bottom:16px; display:none;"></p>

                <div style="display:flex; gap:12px;">
                    <button id="btn-save" onclick="saveProfile()" style="flex:1; background:var(--color-primary); color:white; border:none; padding:12px; border-radius:8px; font-weight:700; cursor:pointer;">Save Changes</button>
                    <button onclick="cancelEdit()" style="flex:1; background:#F3F4F6; color:#374151; border:1px solid #D1D5DB; padding:12px; border-radius:8px; font-weight:700; cursor:pointer;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- NOTIFICATIONS -->
        <div id="notifications" class="screen">
            <h2 class="sec-title" style="margin: 16px 16px 10px 16px;">Notifications</h2>
            <div id="notif-list" style="display:flex; flex-direction:column; gap:12px; max-width:600px; margin: 0 16px;">
                <p style="color:#9CA3AF; text-align:center; padding-top:20px;">Loading notifications...</p>
            </div>
        </div>

    </main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = "https://xdchacdjcgazyckacbpc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDA2MzMsImV4cCI6MjA4NTExNjYzM30.41V3RaUX-ii-EHysbcVpUCgm0-RsNmuOb8FmYsz72Ow";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let userProfile = null;
    let currentUserShop = null; // Store user shop data
    let userCityId = null;
    let userAreaId = null;
    let allCities = [];
    const CACHE_KEY = 'ctm_dash_v14'; // Version bump for dynamic shop card

    // --- NAVIGATION ---
    function toggleSidebar() {
        document.body.classList.toggle('sb-open');
    }

    function switchScreen(id, btn) {
        if (btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const target = document.getElementById(id);
        if (target) target.classList.add('active');

        document.body.classList.remove('sb-open');
        if(id === 'notifications') markRead();
    }

    // --- INIT ---
    window.onload = async () => {
        const { data: { session } } = await client.auth.getSession();
        if (!session) { window.location.href = "login.html"; return; }
        currentUser = session.user;

        const cache = localStorage.getItem(CACHE_KEY);
        if (cache) {
            renderData(JSON.parse(cache));
            fetchData(); 
        } else {
            fetchData();
        }
    };

    async function fetchData() {
        try {
            // Fetch Profile
            const { data: profile } = await client.from('profiles').select('*, cities(name)').eq('id', currentUser.id).single();
            if(!profile) return;
            
            userProfile = profile;
            userCityId = profile.city_id;
            userAreaId = profile.area_id;

            // Fetch Dashboard Data
            const [promos, announcements, categories, areas, shops, notifs, myShop] = await Promise.all([
                client.from('promo_banners').select().order('created_at', {ascending: false}),
                client.from('announcements').select().order('created_at', {ascending: false}),
                client.from('categories').select().order('name'),
                client.from('areas').select().eq('city_id', userCityId).order('name'),
                client.from('shops').select().eq('city_id', userCityId).order('is_verified', {ascending: false}),
                client.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', {ascending: false}).limit(20),
                // ADDED: Fetch current user's shop status
                client.from('shops').select('id, status, rejection_reason').eq('owner_id', currentUser.id).maybeSingle()
            ]);

            currentUserShop = myShop.data;

            // Fetch Products
            let products = [];
            const shopIds = shops.data.map(s => s.id);
            if(shopIds.length > 0) {
                const { data } = await client.from('products')
                    .select('shop_id, image_url')
                    .in('shop_id', shopIds)
                    .eq('is_available', true)
                    .limit(500);
                products = data || [];
            }
            
            // Notification Count
            const unreadCount = notifs.data ? notifs.data.filter(n => !n.is_read).length : 0;

            const dashboardData = {
                profile,
                promos: promos.data,
                announcements: announcements.data,
                categories: categories.data,
                areas: areas.data,
                shops: shops.data,
                notifications: notifs.data || [],
                myShop: myShop.data,
                products,
                unread: unreadCount
            };

            localStorage.setItem(CACHE_KEY, JSON.stringify(dashboardData));
            renderData(dashboardData);
        } catch (e) { console.error("Fetch error:", e); }
    }

    function renderData(data) {
        // Clear loader
        const areaContainer = document.getElementById('areas-container');
        if(areaContainer.querySelector('.fa-spin')) areaContainer.innerHTML = '';

        // Profile UI
        document.getElementById('header-city').textContent = data.profile.cities?.name || "Unknown";
        const avatar = data.profile.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${data.profile.full_name}`;
        document.getElementById('header-avatar').src = avatar;
        document.getElementById('profile-avatar-lg').src = avatar;
        document.getElementById('profile-name').textContent = data.profile.full_name;
        document.getElementById('profile-phone').textContent = data.profile.phone || "No phone number added";
        document.getElementById('profile-email').textContent = currentUser.email;

        // Badge
        if (data.unread > 0) {
            const b = document.getElementById('badge-count');
            b.textContent = data.unread > 9 ? '9+' : data.unread;
            b.style.display = 'block';
        }

        // Ticker
        if (data.announcements && data.announcements.length > 0) {
            document.getElementById('header-ticker').style.display = 'flex';
            document.getElementById('ticker-text').textContent = data.announcements.map(a => a.message).join("  •  ");
        } else {
            document.getElementById('header-ticker').style.display = 'none';
        }

        // Promos
        const pList = document.getElementById('promo-list');
        if (data.promos.length > 0) {
            pList.style.display = 'flex';
            pList.innerHTML = data.promos.map(p => 
                `<div style="min-width:300px; height:160px; border-radius:12px; overflow:hidden; flex-shrink:0;">
                    <img src="${p.image_url}" style="width:100%; height:100%; object-fit:cover;">
                 </div>`
            ).join('');
        }

        // Featured
        const featured = data.shops.filter(s => s.is_featured);
        if (featured.length > 0) {
            document.getElementById('featured-section').style.display = 'block';
            document.getElementById('featured-list').innerHTML = featured.map(s => buildShopCard(s, data.products)).join('');
        }

        // Areas logic
        areaContainer.innerHTML = '';
        const sortedAreas = data.areas.sort((a,b) => (a.id === userAreaId ? -1 : (b.id === userAreaId ? 1 : a.name.localeCompare(b.name))));

        sortedAreas.forEach(area => {
            const areaShops = data.shops.filter(s => s.area_id === area.id);
            if(areaShops.length === 0) return;

            const isUser = area.id === userAreaId;
            const pillClass = isUser ? 'user' : 'other';
            const iconColor = isUser ? 'var(--color-primary)' : '#F59E0B';
            const icon = isUser ? '<i class="fa-solid fa-location-crosshairs"></i>' : '<i class="fa-solid fa-location-dot"></i>';
            const title = isUser ? `Merchants in ${area.name} • Near You` : `Merchants in ${area.name}`;

            areaContainer.innerHTML += `
                <div class="area-container">
                    <div class="area-pill ${pillClass}">
                        <div class="pill-left">
                            <span style="color:${iconColor}; font-size:1.1rem;">${icon}</span>
                            <span>${title}</span>
                        </div>
                        <button onclick="window.location.href='area.html?id=${area.id}'" style="border:none; background:none; color:var(--color-primary); font-weight:700; cursor:pointer;">See All</button>
                    </div>
                    <div class="h-scroll">
                        ${areaShops.map(s => buildShopCard(s, data.products)).join('')}
                    </div>
                </div>
            `;
        });

        // Categories
        document.getElementById('category-list').innerHTML = data.categories.map(cat => {
            const shopIds = data.shops.filter(s => s.category === cat.name).map(s => s.id);
            const p = data.products.find(x => shopIds.includes(x.shop_id) && x.image_url);
            const url = p ? p.image_url : `https://via.placeholder.com/32?text=${cat.name.charAt(0)}`;
            return `
                <div class="cat-chip" onclick="window.location.href='cat.html?name=${cat.name}'">
                    <img src="${url}"> <span>${cat.name}</span>
                </div>
            `;
        }).join('');

        // All Shops
        document.getElementById('all-shops-grid').innerHTML = data.shops.map(s => buildShopCard(s, data.products)).join('');

        // Notifications
        const notifListEl = document.getElementById('notif-list');
        if (data.notifications && data.notifications.length > 0) {
            notifListEl.innerHTML = data.notifications.map(n => {
                const date = new Date(n.created_at).toLocaleDateString() + ' ' + new Date(n.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const bg = n.is_read ? 'white' : '#EFF6FF'; 
                const border = n.is_read ? '#E5E7EB' : '#BFDBFE'; 
                const titleColor = n.is_read ? '#1F2937' : '#1E3A8A';

                return `
                    <div style="background:${bg}; padding:16px; border-radius:12px; border:1px solid ${border}; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                            <span style="font-weight:700; color:${titleColor}; font-size:0.95rem;">${n.title}</span>
                            <span style="font-size:0.75rem; color:#6B7280;">${date}</span>
                        </div>
                        <div style="color:#374151; font-size:0.9rem; line-height:1.4;">${n.message || ''}</div>
                    </div>
                `;
            }).join('');
        } else {
            notifListEl.innerHTML = '<p style="color:#9CA3AF; text-align:center; margin-top:20px;">No notifications yet</p>';
        }

        // UPDATE MY SHOP CARD UI
        updateMyShopCardUI(data.myShop);
        currentUserShop = data.myShop;
    }

    // --- MY SHOP CARD LOGIC ---
    function updateMyShopCardUI(shop) {
        const card = document.getElementById('myshop-card');
        const iconContainer = card.querySelector('.svc-icon');
        const textLabel = card.querySelector('strong');
        
        // Defaults (No Shop)
        let icon = 'fa-store';
        let bg = '#DBEAFE'; // Blue-100
        let color = '#2563EB'; // Blue-600
        let label = 'Register Shop';
        
        if (shop) {
            if (shop.status === 'pending') {
                icon = 'fa-hourglass-half';
                bg = '#FFEDD5'; // Orange-100
                color = '#EA580C'; // Orange-600
                label = 'Pending';
            } else if (shop.status === 'approved') {
                icon = 'fa-store';
                bg = '#DCFCE7'; // Green-100
                color = '#16A34A'; // Green-600
                label = 'My Shop';
            } else if (shop.status === 'rejected') {
                icon = 'fa-circle-exclamation';
                bg = '#FEE2E2'; // Red-100
                color = '#DC2626'; // Red-600
                label = 'Rejected';
            }
        }
        
        iconContainer.style.background = bg;
        iconContainer.style.color = color;
        iconContainer.innerHTML = `<i class="fa-solid ${icon}"></i>`;
        textLabel.textContent = label;
    }

    function handleShopClick() {
        if (!currentUserShop) {
            // 1. Register
            window.location.href = 'shop-registration.html';
        } else if (currentUserShop.status === 'pending') {
            // 2. Pending
            alert('Your shop application is currently being reviewed. Please check back later.');
        } else if (currentUserShop.status === 'approved') {
            // 3. Dashboard
            window.location.href = 'merchant-dashboard.html';
        } else if (currentUserShop.status === 'rejected') {
            // 4. Rejected
            alert(`Application Rejected: ${currentUserShop.rejection_reason || 'Please update your details.'}`);
            window.location.href = `shop-registration.html?id=${currentUserShop.id}`; 
        }
    }

    // --- PROFILE EDIT LOGIC ---

    async function openEditProfile() {
        if(!userProfile) return;

        // Toggle Views
        document.getElementById('profile-view').style.display = 'none';
        document.getElementById('profile-edit').style.display = 'block';

        // Pre-fill Data
        document.getElementById('edit-name').value = userProfile.full_name || '';
        document.getElementById('edit-phone').value = userProfile.phone || '';

        // Load Cities if not loaded
        if(allCities.length === 0) {
            const { data } = await client.from('cities').select('id, name').order('name');
            allCities = data || [];
            
            const citySelect = document.getElementById('edit-city');
            citySelect.innerHTML = '<option value="">Select City</option>';
            allCities.forEach(c => {
                citySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }

        // Set City and Trigger Area Load
        if(userProfile.city_id) {
            document.getElementById('edit-city').value = userProfile.city_id;
            await handleCityChange(userProfile.city_id, userProfile.area_id);
        }
    }

    async function handleCityChange(cityId, preSelectAreaId = null) {
        const areaSelect = document.getElementById('edit-area');
        areaSelect.innerHTML = '<option value="">Loading...</option>';
        areaSelect.disabled = true;

        if(!cityId) {
            areaSelect.innerHTML = '<option value="">Select Area</option>';
            return;
        }

        const { data: areas } = await client.from('areas').select('id, name').eq('city_id', cityId).order('name');
        
        areaSelect.innerHTML = '<option value="">Select Area</option>';
        if(areas) {
            areas.forEach(a => {
                areaSelect.innerHTML += `<option value="${a.id}">${a.name}</option>`;
            });
        }
        areaSelect.disabled = false;

        if(preSelectAreaId) {
            areaSelect.value = preSelectAreaId;
        }
    }

    function cancelEdit() {
        document.getElementById('profile-edit').style.display = 'none';
        document.getElementById('profile-view').style.display = 'block';
        document.getElementById('edit-error').style.display = 'none';
    }

    async function saveProfile() {
        const name = document.getElementById('edit-name').value.trim();
        const phone = document.getElementById('edit-phone').value.trim();
        const cityId = document.getElementById('edit-city').value;
        const areaId = document.getElementById('edit-area').value;
        const btn = document.getElementById('btn-save');
        const err = document.getElementById('edit-error');

        if(!name) {
            err.textContent = "Full Name is required.";
            err.style.display = 'block';
            return;
        }
        if(!cityId || !areaId) {
            err.textContent = "Please select both City and Area.";
            err.style.display = 'block';
            return;
        }

        btn.disabled = true;
        btn.textContent = "Saving...";
        err.style.display = 'none';

        try {
            const { error } = await client.from('profiles').update({
                full_name: name,
                phone: phone,
                city_id: parseInt(cityId),
                area_id: parseInt(areaId)
            }).eq('id', currentUser.id);

            if(error) throw error;

            // Success: reload data to update global UI (areas, header city, etc)
            await fetchData();
            cancelEdit(); // Close form
            alert("Profile updated successfully!");

        } catch (e) {
            err.textContent = e.message || "Error updating profile";
            err.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = "Save Changes";
        }
    }

    function buildShopCard(shop, allProducts) {
        const p = allProducts.filter(x => x.shop_id === shop.id && x.image_url).slice(0, 4);
        let collage = '';
        if(p.length === 0) {
            const fallback = shop.image_url || 'https://via.placeholder.com/240x150?text=No+Image';
            collage = `<div class="collage c-1"><img src="${fallback}"></div>`;
        } else if(p.length === 1) {
            collage = `<div class="collage c-1"><img src="${p[0].image_url}"></div>`;
        } else if(p.length === 2) {
            collage = `<div class="collage c-2"><img src="${p[0].image_url}"><img src="${p[1].image_url}"></div>`;
        } else if(p.length === 3) {
            collage = `
                <div class="collage c-3">
                    <img src="${p[0].image_url}">
                    <div><img src="${p[1].image_url}"><img src="${p[2].image_url}"></div>
                </div>`;
        } else {
            collage = `
                <div class="collage c-4">
                    <img src="${p[0].image_url}"><img src="${p[1].image_url}">
                    <img src="${p[2].image_url}"><img src="${p[3].image_url}">
                </div>`;
        }

        // Extract ID Badge Logic
        const rawId = shop.unique_id || 'N/A';
        const displayId = rawId.includes('-') ? rawId.split('-').pop() : rawId;

        return `
            <div class="shop-card" onclick="window.location.href='shop-detail.html?id=${shop.id}'">
                <div class="img-box">${collage}</div>
                <div class="info-box">
                    <div class="s-name">${shop.name}</div>
                    
                    <!-- REPLACED CATEGORY WITH CT ID -->
                    <span class="s-id-badge">ID: ${displayId}</span>
                    
                    <div class="s-loc"><i class="fa-solid fa-location-dot"></i> ${shop.address}</div>
                </div>
            </div>
        `;
    }

    async function handleLogout() {
        if(confirm("Log out?")) {
            await client.auth.signOut();
            window.location.href = "index.html";
        }
    }
    async function markRead() {
        document.getElementById('badge-count').style.display = 'none';
        await client.from('notifications').update({is_read: true}).eq('user_id', currentUser.id);
    }
</script>
</body>
</html>
