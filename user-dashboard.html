<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personnel Dashboard | CT‚ÄëMerchant</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="styles.css">
  
  <link rel="stylesheet" href="user-dashboard.css">
</head>
<body class="dashboard-body">

<div class="dashboard-wrapper">

  <div class="mobile-topbar">
    <div class="topbar-brand">
      <img src="https://goodtvrhszsnhcyigfoi.supabase.co/storage/v1/object/public/ctm_web_files/CT-Merchant.jpg" class="topbar-logo">
      <span class="topbar-title">CT‚ÄëMERCHANT</span>
    </div>
    <button id="menu-toggle" class="btn-menu">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
  </div>

  <aside id="sidebar" class="sidebar closed">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <img src="https://goodtvrhszsnhcyigfoi.supabase.co/storage/v1/object/public/ctm_web_files/CT-Merchant.jpg" class="sidebar-logo">
        <span class="sidebar-brand-text">Portal</span>
      </div>
      <button id="close-menu" class="btn-close-menu">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <nav class="nav-list">
      <a href="#" class="nav-link active">üè† Dashboard</a>
      <a href="#" class="nav-link">üì¶ Orders</a>
      <a href="#" class="nav-link">üë§ Profile</a>
      
      <div class="sidebar-footer">
        <button onclick="logout()" class="btn-logout-sidebar">
          üö™ Logout
        </button>
      </div>
    </nav>
  </aside>

  <div id="sidebar-overlay" class="mobile-overlay"></div>

  <main class="main-content">
    
    <div class="stats-grid animate-up">
      <div class="stat-card border-l-purple">
        <span class="stat-label">Live Orders</span>
        <p id="orders-count" class="stat-value text-purple">--</p>
      </div>
      <div class="stat-card border-l-pink">
        <span class="stat-label">Merchants</span>
        <p id="merchants-count" class="stat-value text-pink">--</p>
      </div>
      <div class="stat-card border-l-blue">
        <span class="stat-label">Sync Health</span>
        <p id="profiles-complete" class="stat-value text-blue">--</p>
      </div>
    </div>

    <div id="profiles-list" class="profiles-grid">
      <div id="loading-spinner" class="spinner-container">
        <div class="loading-spinner"></div>
      </div>
    </div>

  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://goodtvrhszsnhcyigfoi.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdvb2R0dnJoc3pzbmhjeWlnZm9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMTIzMjEsImV4cCI6MjA4MDY4ODMyMX0.FM80U_YHA-DnPqMnD4oEiNGI07BSxGcHGqeH4JP1HlI";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Sidebar Mobile Logic
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  const toggle = document.getElementById('menu-toggle');
  const close = document.getElementById('close-menu');

  const toggleSidebar = () => {
    sidebar.classList.toggle('closed');
    overlay.classList.toggle('active');
    document.body.style.overflow = document.body.style.overflow === 'hidden' ? '' : 'hidden';
  };

  if(toggle) toggle.onclick = toggleSidebar;
  if(close) close.onclick = toggleSidebar;
  if(overlay) overlay.onclick = toggleSidebar;

  // Animation Observer
  const animationObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        animationObserver.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });

  async function logout() {
    await client.auth.signOut();
    window.location.href = "index.html";
  }

  async function loadProfiles() {
    const container = document.getElementById('profiles-list');
    
    try {
      // 1. Fetch profiles
      const { data: profiles, error } = await client.from('profiles').select('*');
      if (error) throw error;

      document.getElementById('orders-count').textContent = "1.2k"; 
      
      // 2. Friendly Empty State
      if (!profiles || profiles.length === 0) {
        document.getElementById('merchants-count').textContent = "0";
        document.getElementById('profiles-complete').textContent = "0%";
        container.innerHTML = `
          <div style="grid-column: 1 / -1;" class="animate-up visible">
            <div class="glass-card" style="padding: 3rem; text-align: center; border-top: 8px solid var(--color-pink);">
              <div style="margin-bottom: 1.5rem; display: inline-flex; padding: 1rem; border-radius: 50%; background-color: #fdf2f8;">
                <svg style="width: 3rem; height: 3rem; color: var(--color-pink);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
              </div>
              <h2 style="font-size: 1.5rem; font-weight: 800; color: var(--color-purple); margin-bottom: 0.75rem;">Complete Your Setup</h2>
              <p style="color: #64748b; max-width: 28rem; margin: 0 auto 2rem auto;">
                Profile creation is managed through our Android application. Install the app to unlock the full market experience.
              </p>
              <a href="#" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 2rem; bg-color: var(--color-purple); color: white; border-radius: 0.75rem; font-weight: 700; background-color: var(--color-purple);">
                Download Android App
              </a>
            </div>
          </div>
        `;
        return;
      }

      // 3. Populate Stats
      document.getElementById('merchants-count').textContent = profiles.length;
      const completeCount = profiles.filter(p => p.is_profile_complete).length;
      document.getElementById('profiles-complete').textContent = Math.round((completeCount / profiles.length) * 100) + "%";

      // 4. Fetch Cities & Areas for lookup table
      const [{data: cities}, {data: areas}] = await Promise.all([
        client.from('cities').select('id, name'),
        client.from('areas').select('id, name')
      ]);

      const cityMap = Object.fromEntries(cities?.map(c => [c.id, c.name]) || []);
      const areaMap = Object.fromEntries(areas?.map(a => [a.id, a.name]) || []);

      // 5. Build Cards
      container.innerHTML = "";
      profiles.forEach((profile, index) => {
        const card = document.createElement('div');
        card.className = "glass-card animate-up group";
        // Inline delay for staggered animation effect
        card.style.transitionDelay = `${index * 30}ms`;
        
        const cityName = cityMap[profile.selected_location_city] || "Unknown City";
        const areaName = areaMap[profile.selected_location_area] || "Unknown Area";
        const avatarUrl = profile.avatar_url || 'https://api.dicebear.com/7.x/initials/svg?seed=' + encodeURIComponent(profile.full_name || 'U');

        card.innerHTML = `
          <div class="profile-header">
            <div class="profile-img-box">
              <img src="${avatarUrl}" class="profile-avatar">
              <span class="status-dot ${profile.is_profile_complete ? 'bg-green' : 'bg-gray'}"></span>
            </div>
            <div class="profile-title-box">
              <h3 class="profile-name">${profile.full_name || 'Merchant'}</h3>
              <p class="profile-id">${profile.ct_merchant_id || 'ID Pending'}</p>
            </div>
          </div>
          
          <div class="profile-body">
            <div class="profile-row">
               <span class="row-label">Location</span>
               <span class="row-value text-purple-sm">${cityName}</span>
            </div>
            <div class="profile-row">
               <span class="row-label">Area</span>
               <span class="row-value text-dark">${areaName}</span>
            </div>
            <div class="profile-row">
               <span class="row-label">Contact</span>
               <span class="row-value text-dark" style="max-width: 120px;">${profile.phone_number || 'N/A'}</span>
            </div>
            <div class="profile-row" style="margin-top: 0.25rem;">
               <span class="role-badge">${profile.role || 'Member'}</span>
               <button class="btn-view-store">View Store ‚Üí</button>
            </div>
          </div>
        `;
        container.appendChild(card);
        animationObserver.observe(card);
      });

    } catch (err) {
      console.error(err);
      container.innerHTML = `<div style="grid-column: 1 / -1; padding: 5rem 0; text-align: center; color: rgba(255,255,255,0.8);">Failed to load profiles. Please try again.</div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadProfiles();
    document.querySelectorAll('.animate-up').forEach(el => animationObserver.observe(el));
  });
</script>
</body>
</html>
