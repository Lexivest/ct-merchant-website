<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Details | CT‑Merchant</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        :root {
            --color-primary: #6B21A8;
            --color-purple-light: #F3E8FF;
            --color-pink: #DB2777;
            --color-bg: #F8FAFC;
            --color-text: #1E293B;
            --color-text-muted: #64748B;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--color-bg); 
            color: var(--color-text); 
            padding-bottom: 90px;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background-color: var(--color-bg);
        }

        /* --- TOP BAR --- */
        .top-bar {
            position: sticky; top: 0; z-index: 50;
            background: white; border-bottom: 1px solid #E2E8F0;
            padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .nav-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none; background: #F1F5F9;
            color: var(--color-text); font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background 0.2s;
        }
        .nav-btn:hover { background: #E2E8F0; }

        .page-title { font-weight: 800; font-size: 1.1rem; color: var(--color-text); }

        /* --- SHOP INFO --- */
        .info-card { padding: 24px; }

        .shop-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .shop-name { font-size: 1.5rem; font-weight: 800; width: 85%; line-height: 1.2; color: var(--color-text); }
        .verified-seal { width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow-md); }

        .category-tag { font-weight: 700; color: var(--color-primary); font-size: 0.9rem; margin-bottom: 12px; }

        .address-row { display: flex; gap: 8px; color: var(--color-text-muted); font-size: 0.9rem; align-items: flex-start; margin-bottom: 16px; line-height: 1.4; }

        .status-row { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; }
        
        .status-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 700;
            background: #EFF6FF; color: #1E40AF; border: 1px solid #DBEAFE;
        }
        .status-badge.pending { background: #FEF2F2; color: #B91C1C; border-color: #FEE2E2; }
        .status-badge img { width: 14px; height: 14px; border-radius: 50%; }

        .like-btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 700;
            background: white; color: var(--color-text); border: 1px solid #E2E8F0;
            cursor: pointer; transition: all 0.2s;
        }
        .like-btn.liked { background: #FDF2F8; color: var(--color-pink); border-color: #FBCFE8; }

        .news-ticker {
            background: #FFF7ED; border: 1px solid #FFEDD5; color: #C2410C;
            padding: 12px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px; margin-bottom: 24px;
        }

        /* --- PRODUCTS GRID --- */
        .section-title { 
            display: flex; align-items: center; gap: 10px; 
            font-size: 1.1rem; font-weight: 800; margin: 30px 0 16px 0; color: #334155;
        }
        .bar { width: 4px; height: 24px; border-radius: 2px; }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }
        
        .product-card {
            background: white; border-radius: 12px; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #E2E8F0;
            cursor: pointer; position: relative; transition: transform 0.2s;
        }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: var(--color-primary); }

        .prod-img { width: 100%; height: 160px; object-fit: cover; }
        .prod-info { padding: 12px; }
        .prod-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #334155; }
        .prod-price { color: var(--color-primary); font-weight: 800; font-size: 1rem; }
        .prod-price.discounted { color: #DC2626; }
        .prod-old-price { text-decoration: line-through; color: #94A3B8; font-size: 0.8rem; margin-right: 4px; }
        
        .badge {
            position: absolute; top: 8px; padding: 2px 8px; border-radius: 4px; 
            font-size: 0.7rem; font-weight: 700; color: white;
        }
        .badge-discount { left: 8px; background: #DC2626; }
        .badge-used { right: 8px; background: #EA580C; }

        /* --- MAP & STOREFRONT --- */
        .storefront-img { width: 100%; height: 250px; border-radius: 12px; object-fit: cover; margin-bottom: 12px; display: none; }
        #map { height: 250px; width: 100%; border-radius: 12px; border: 1px solid #E2E8F0; z-index: 1; }

        /* --- BOTTOM BAR --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 1200px;
            background: white; padding: 12px 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100;
            border-top: 1px solid #E2E8F0;
            display: flex; justify-content: center;
        }
        .btn-whatsapp {
            width: 100%; max-width: 600px; 
            background: #22C55E; color: white;
            padding: 14px; border-radius: 12px; border: none;
            font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; transition: background 0.2s;
        }
        .btn-whatsapp:hover { background: #16A34A; }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 320px; text-align: center; }
        .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; }
        .btn-cancel { background: #F1F5F9; color: #475569; }
        .btn-confirm { background: var(--color-primary); color: white; }

        .hidden { display: none; }
        .spinner { width: 32px; height: 32px; border: 3px solid #E2E8F0; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Top Bar -->
    <div class="top-bar">
        <button onclick="history.back()" class="nav-btn"><i class="fa-solid fa-arrow-left"></i></button>
        <span class="page-title">Shop Details</span>
        <button onclick="shareShop()" class="nav-btn"><i class="fa-solid fa-share-nodes"></i></button>
    </div>

    <!-- Info Section -->
    <div class="info-card">
        <div id="loading-spinner" class="spinner"></div>
        <div id="content-area" class="hidden">
            
            <div class="shop-header-row">
                <div id="shop-name" class="shop-name">Loading...</div>
                <img id="verified-seal" src="https://goodtvrhszsnhcyigfoi.supabase.co/storage/v1/object/public/ctm_web_files/CT-Merchant.jpg" class="verified-seal hidden">
            </div>
            
            <div id="shop-category" class="category-tag"></div>
            
            <div class="address-row">
                <i class="fa-solid fa-location-dot" style="margin-top:2px;"></i>
                <span id="shop-address"></span>
            </div>

            <div class="status-row">
                <div id="status-badge" class="status-badge"></div>
                <button id="like-btn" class="like-btn" onclick="toggleLike()">
                    <i class="fa-regular fa-thumbs-up"></i>
                    <span id="like-count">0</span>
                </button>
            </div>

            <div id="news-ticker" class="news-ticker hidden">
                <i class="fa-solid fa-bullhorn"></i>
                <span id="news-text"></span>
            </div>

            <hr style="border:0; border-top:1px solid #E2E8F0; margin: 24px 0;">

            <!-- Product Sections -->
            <div id="section-special" class="hidden">
                <div class="section-title"><div class="bar" style="background:red;"></div> Special Offers</div>
                <div id="grid-special" class="product-grid"></div>
            </div>

            <div id="section-used" class="hidden">
                <div class="section-title"><div class="bar" style="background:orange;"></div> Fairly Used Deals</div>
                <div id="grid-used" class="product-grid"></div>
            </div>

            <div id="section-new" class="hidden">
                <div class="section-title"><div class="bar" style="background:var(--color-primary);"></div> New Stocks</div>
                <div id="grid-new" class="product-grid"></div>
            </div>

            <div id="empty-state" class="hidden" style="text-align:center; padding: 40px 0; color:grey;">
                <i class="fa-solid fa-box-open" style="font-size: 32px; margin-bottom:10px;"></i>
                <p>No products listed yet.</p>
            </div>

            <!-- Storefront & Map -->
            <div id="location-section" class="hidden">
                <hr style="border:0; border-top:1px solid #E2E8F0; margin: 30px 0;">
                
                <div class="section-title">Physical Store</div>
                <img id="storefront-img" class="storefront-img">
                
                <div class="section-title">Location Map</div>
                <div id="map"></div>
                <div style="text-align:right; margin-top:8px;">
                    <button onclick="openGoogleMaps()" style="background:white; border:1px solid #ccc; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.85rem;">
                        Open in Google Maps <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
        <button onclick="showSecurityModal()" class="btn-whatsapp">
            <i class="fa-brands fa-whatsapp" style="font-size:1.2rem;"></i> Chat on WhatsApp
        </button>
    </div>
</div>

<!-- Security Modal -->
<div id="security-modal" class="modal-overlay">
    <div class="modal-card">
        <i class="fa-solid fa-shield-halved" style="font-size: 2.5rem; color: var(--color-primary); margin-bottom: 16px;"></i>
        <h3 style="margin-bottom: 8px;">Security Notice</h3>
        <p style="font-size: 0.85rem; color: #64748B; line-height: 1.5;">
            To protect merchants from spam, your User ID will be recorded. Please ensure this inquiry is business-related.
        </p>
        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="hideSecurityModal()">Cancel</button>
            <button class="btn-modal btn-confirm" onclick="launchWhatsApp()">I Understand</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    const SUPABASE_URL = "https://xdchacdjcgazyckacbpc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDA2MzMsImV4cCI6MjA4NTExNjYzM30.41V3RaUX-ii-EHysbcVpUCgm0-RsNmuOb8FmYsz72Ow";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(window.location.search);
    const shopId = params.get('id');

    let currentShop = null;
    let currentUser = null;
    let hasLiked = false;
    let likeCount = 0;

    window.onload = async () => {
        if (!shopId) { window.history.back(); return; }

        const { data: { session } } = await client.auth.getSession();
        if (session) currentUser = session.user;

        const cached = localStorage.getItem(`shop_cache_${shopId}`);
        if (cached) {
            renderShopData(JSON.parse(cached));
        }

        fetchShopData();
    };

    async function fetchShopData() {
        try {
            const [shopRes, prodRes, likeRes] = await Promise.all([
                client.from('shops').select().eq('id', shopId).maybeSingle(),
                client.from('products').select().eq('shop_id', shopId).eq('is_available', true).order('created_at', { ascending: false }),
                client.from('shop_likes').select('id', { count: 'exact' }).eq('shop_id', shopId)
            ]);

            if (!shopRes.data) return;

            let userLiked = false;
            if (currentUser) {
                const { data } = await client.from('shop_likes').select('id').eq('shop_id', shopId).eq('user_id', currentUser.id).maybeSingle();
                if (data) userLiked = true;
            }

            const data = {
                shop: shopRes.data,
                products: prodRes.data || [],
                likeCount: likeRes.count || 0,
                hasLiked: userLiked
            };

            localStorage.setItem(`shop_cache_${shopId}`, JSON.stringify(data));
            renderShopData(data);
            logView();

        } catch (e) {
            console.error("Fetch error:", e);
            document.getElementById('loading-spinner').style.display = 'none';
        }
    }

    function renderShopData(data) {
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('content-area').classList.remove('hidden');

        const s = data.shop;
        currentShop = s;
        hasLiked = data.hasLiked;
        likeCount = data.likeCount;

        document.getElementById('shop-name').textContent = s.name;
        document.getElementById('shop-category').textContent = s.category;
        document.getElementById('shop-address').textContent = s.address;
        
        if (s.is_verified) {
            document.getElementById('verified-seal').classList.remove('hidden');
            document.getElementById('status-badge').className = "status-badge";
            document.getElementById('status-badge').innerHTML = `<img src="https://goodtvrhszsnhcyigfoi.supabase.co/storage/v1/object/public/ctm_web_files/CT-Merchant.jpg"> ${s.unique_id || 'Verified'}`;
        } else {
            document.getElementById('status-badge').className = "status-badge pending";
            document.getElementById('status-badge').textContent = "Pending Verification";
        }

        updateLikeUI();

        if (s.news) {
            document.getElementById('news-text').textContent = s.news;
            document.getElementById('news-ticker').classList.remove('hidden');
        }

        const special = data.products.filter(p => p.discount_price && p.discount_price < p.price);
        const used = data.products.filter(p => p.condition === 'Fairly Used');
        const fresh = data.products.filter(p => !p.discount_price && p.condition !== 'Fairly Used');

        renderGrid('grid-special', 'section-special', special);
        renderGrid('grid-used', 'section-used', used);
        renderGrid('grid-new', 'section-new', fresh);

        if (data.products.length === 0) document.getElementById('empty-state').classList.remove('hidden');

        // Location & Storefront Logic
        if (s.is_verified && (s.storefront_url || s.latitude)) {
            document.getElementById('location-section').classList.remove('hidden');
            
            // Fix: Use correct 'storefront_url' property
            if (s.storefront_url) {
                const imgEl = document.getElementById('storefront-img');
                imgEl.src = s.storefront_url;
                imgEl.style.display = 'block';
            }
            
            if (s.latitude && s.longitude) initMap(s.latitude, s.longitude);
        }
    }

    function renderGrid(gridId, sectionId, products) {
        if (products.length === 0) return;
        document.getElementById(sectionId).classList.remove('hidden');
        document.getElementById(gridId).innerHTML = products.map(p => {
            const hasDiscount = p.discount_price && p.discount_price < p.price;
            const percent = hasDiscount ? Math.round(((p.price - p.discount_price)/p.price)*100) : 0;
            
            return `
            <div class="product-card" onclick="window.location.href='product-detail.html?id=${p.id}'">
                <img src="${p.image_url || 'https://via.placeholder.com/150'}" class="prod-img">
                ${hasDiscount ? `<span class="badge badge-discount">-${percent}%</span>` : ''}
                ${p.condition === 'Fairly Used' ? `<span class="badge badge-used">Used</span>` : ''}
                <div class="prod-info">
                    <div class="prod-name">${p.name}</div>
                    <div class="prod-price ${hasDiscount ? 'discounted' : ''}">
                        ${hasDiscount ? `<span class="prod-old-price">₦${p.price.toLocaleString()}</span>` : ''}
                        ₦${(p.discount_price || p.price).toLocaleString()}
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    let map;
    function initMap(lat, lng) {
        if (map) return;
        setTimeout(() => {
            map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
            L.marker([lat, lng]).addTo(map).bindPopup("Shop Location").openPopup();
        }, 500);
    }

    function openGoogleMaps() {
        if (!currentShop?.latitude) return;
        window.open(`https://www.google.com/maps/search/?api=1&query=${currentShop.latitude},${currentShop.longitude}`, '_blank');
    }

    function updateLikeUI() {
        const btn = document.getElementById('like-btn');
        const txt = document.getElementById('like-count');
        txt.textContent = likeCount;
        if (hasLiked) {
            btn.classList.add('liked');
            btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
        } else {
            btn.classList.remove('liked');
            btn.querySelector('i').classList.replace('fa-solid', 'fa-regular');
        }
    }

    async function toggleLike() {
        if (!currentUser) return alert("Please sign in to like shops.");
        hasLiked = !hasLiked;
        likeCount += hasLiked ? 1 : -1;
        updateLikeUI();

        try {
            if (hasLiked) {
                await client.from('shop_likes').insert({ shop_id: shopId, user_id: currentUser.id });
            } else {
                await client.from('shop_likes').delete().eq('shop_id', shopId).eq('user_id', currentUser.id);
            }
        } catch (e) {
            hasLiked = !hasLiked;
            likeCount += hasLiked ? 1 : -1;
            updateLikeUI();
        }
    }

    function showSecurityModal() {
        if (!currentShop?.whatsapp) return alert("This shop hasn't provided a WhatsApp number.");
        document.getElementById('security-modal').classList.add('active');
    }
    function hideSecurityModal() {
        document.getElementById('security-modal').classList.remove('active');
    }

    async function launchWhatsApp() {
        hideSecurityModal();
        let phone = currentShop.whatsapp.replace(/\D/g, '');
        if (phone.startsWith('0')) phone = '234' + phone.substring(1);
        
        const msg = `Hello ${currentShop.name}, I found your shop on CT-Merchant.`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');

        if (currentUser) {
            await client.from('whatsapp_clicks').insert({ clicker_id: currentUser.id, shop_id: shopId });
        }
    }

    async function logView() {
        if (currentUser && currentUser.id !== currentShop.owner_id) {
            await client.from('shop_views').insert({ shop_id: shopId, viewer_id: currentUser.id });
        }
    }

    function shareShop() {
        if (navigator.share) {
            navigator.share({
                title: currentShop.name,
                text: `Check out ${currentShop.name} on CT-Merchant!`,
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(window.location.href);
            alert("Link copied to clipboard!");
        }
    }
</script>
</body>
</html>
