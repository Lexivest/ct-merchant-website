<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Settings | CTâ€‘Merchant</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --color-purple: #2E1065;
            --color-bg: #F8FAFC;
            --color-text: #1E293B;
            --color-border: #E2E8F0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--color-bg); color: var(--color-text); min-height: 100vh; display: flex; justify-content: center; padding: 20px; }

        .container { width: 100%; max-width: 500px; }

        /* Header */
        .app-bar { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .back-btn { background: white; border: 1px solid var(--color-border); width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--color-text); font-size: 1.1rem; }
        .page-title { font-size: 1.25rem; font-weight: 800; }
        
        .save-btn {
            margin-left: auto; background: none; border: none; color: var(--color-purple);
            font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 6px;
        }
        .save-btn:disabled { color: #94A3B8; cursor: not-allowed; }

        /* Form */
        .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; margin-top: 8px; }
        .divider { height: 1px; background: var(--color-border); margin: 30px 0; }

        .form-group { margin-bottom: 16px; }
        .label { display: block; font-size: 0.85rem; font-weight: 700; color: #64748B; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; }
        .input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--color-border); font-size: 1rem; background: white; transition: border 0.2s; }
        .input:focus { outline: none; border-color: var(--color-purple); }
        textarea.input { min-height: 100px; resize: vertical; }

        .helper-text { font-size: 0.75rem; color: #94A3B8; margin-top: 4px; }

        /* Loader & Hidden States */
        .spinner { width: 40px; height: 40px; border: 4px solid #E2E8F0; border-top-color: var(--color-purple); border-radius: 50%; animation: spin 1s linear infinite; margin: 100px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="app-bar">
        <button onclick="history.back()" class="back-btn"><i class="fa-solid fa-arrow-left"></i></button>
        <div class="page-title">Shop Settings</div>
        <button id="save-btn" onclick="updateShop()" class="save-btn">
            <i class="fa-solid fa-check"></i> Save
        </button>
    </div>

    <!-- 1. LOADING STATE -->
    <div id="loader" class="spinner"></div>

    <!-- 2. CONTENT (Hidden initially) -->
    <div id="content" class="hidden">
        <form id="settings-form" onsubmit="event.preventDefault(); updateShop();">
            
            <div class="section-title">Basic Info</div>

            <div class="form-group">
                <label class="label"><i class="fa-solid fa-store"></i> Business Name</label>
                <input type="text" id="name" class="input" required>
            </div>

            <div class="form-group">
                <label class="label"><i class="fa-solid fa-align-left"></i> Description</label>
                <textarea id="desc" class="input" required></textarea>
            </div>

            <div class="form-group">
                <label class="label"><i class="fa-solid fa-location-dot"></i> Physical Address</label>
                <input type="text" id="address" class="input" required>
            </div>

            <div class="divider"></div>

            <div class="section-title">Contact Info</div>

            <div class="form-group">
                <label class="label"><i class="fa-solid fa-phone"></i> Phone Number</label>
                <input type="tel" id="phone" class="input" required>
            </div>

            <div class="form-group">
                <label class="label"><i class="fa-brands fa-whatsapp"></i> WhatsApp Number</label>
                <input type="tel" id="whatsapp" class="input" placeholder="Optional">
                <div class="helper-text">Format: 080... (Must be active on WhatsApp)</div>
            </div>

        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = "https://xdchacdjcgazyckacbpc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY2hhY2RqY2dhenlja2FjYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDA2MzMsImV4cCI6MjA4NTExNjYzM30.41V3RaUX-ii-EHysbcVpUCgm0-RsNmuOb8FmYsz72Ow";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(window.location.search);
    const shopId = params.get('shop_id');
    let currentShop = null;

    window.onload = async () => {
        const { data: { session } } = await client.auth.getSession();
        if (!session) { window.location.href = "login.html"; return; }
        
        if (!shopId) {
            alert("Shop ID missing");
            window.history.back();
            return;
        }

        fetchShopData();
    };

    async function fetchShopData() {
        try {
            const { data, error } = await client.from('shops').select('*').eq('id', shopId).single();
            
            if (error || !data) { 
                alert("Shop not found"); 
                window.history.back(); 
                return;
            }
            
            currentShop = data;
            
            // Populate Form
            document.getElementById('name').value = data.name;
            document.getElementById('desc').value = data.description || '';
            document.getElementById('address').value = data.address;
            document.getElementById('phone').value = data.phone;
            document.getElementById('whatsapp').value = data.whatsapp || '';

            // Reveal Content
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

        } catch (e) {
            console.error(e);
            alert("Error loading shop data");
        }
    }

    async function updateShop() {
        const btn = document.getElementById('save-btn');
        const form = document.getElementById('settings-form');
        
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Saving...';

        try {
            const updates = {
                name: document.getElementById('name').value.trim(),
                description: document.getElementById('desc').value.trim(),
                address: document.getElementById('address').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                whatsapp: document.getElementById('whatsapp').value.trim() || null,
            };

            const { error } = await client.from('shops').update(updates).eq('id', shopId);
            if (error) throw error;

            alert("Shop details updated!");
            window.history.back();

        } catch (err) {
            alert("Update failed: " + err.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
